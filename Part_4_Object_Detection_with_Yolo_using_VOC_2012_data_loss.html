<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>


   <!-- Global site tag (gtag.js) - Google Analytics -->
   <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112020731-1"></script>
   <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());

   gtag('config', 'UA-112020731-1');
   </script>

 

  <meta charset="utf-8">
  <title>Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss</title>
  <meta name="author" content="Yumi">



  <!-- https://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://FairyOnIce.github.io/favicon.png" rel="icon">
  <link href="https://FairyOnIce.github.io/theme/css/main.css" media="screen, projection"
rel="stylesheet" type="text/css">
 <link rel="stylesheet" href="https://FairyOnIce.github.io/theme/tipuesearch.css">
  <script src="https://FairyOnIce.github.io/theme/js/modernizr-2.0.js"></script>
  <script src="https://FairyOnIce.github.io/theme/js/ender.js"></script>
  <script src="https://FairyOnIce.github.io/theme/js/octopress.js" type="text/javascript"></script>

  <link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="https://FairyOnIce.github.io/">Yumi's Blog</a></h1>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:FairyOnIce.github.io" />
    <input class="search" type="text" name="q" results="0"
placeholder="Google Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
    <li><a href="/archives.html">Archives</a></li>
      <li><a href="https://FairyOnIce.github.io/pages/deployment.html">Deployment</a></li>
      <li><a href="https://FairyOnIce.github.io/pages/quest.html">Quest</a></li>
    <li class="active">
    <a href="https://FairyOnIce.github.io/category/blog.html">Blog</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss</h1>
      <p class="meta"><time datetime="2018-12-09T20:00:00-08:00" pubdate>Sun 09 December 2018</time></p>
</header>

  <div class="entry-content"><style type="text/css">/*!
*
* IPython notebook
*
*/
/* CSS font colors for translated ANSI colors. */
.ansibold {
  font-weight: bold;
}
/* use dark versions for foreground, to improve visibility */
.ansiblack {
  color: black;
}
.ansired {
  color: darkred;
}
.ansigreen {
  color: darkgreen;
}
.ansiyellow {
  color: #c4a000;
}
.ansiblue {
  color: darkblue;
}
.ansipurple {
  color: darkviolet;
}
.ansicyan {
  color: steelblue;
}
.ansigray {
  color: gray;
}
/* and light for background, for the same reason */
.ansibgblack {
  background-color: black;
}
.ansibgred {
  background-color: red;
}
.ansibggreen {
  background-color: green;
}
.ansibgyellow {
  background-color: yellow;
}
.ansibgblue {
  background-color: blue;
}
.ansibgpurple {
  background-color: magenta;
}
.ansibgcyan {
  background-color: cyan;
}
.ansibggray {
  background-color: gray;
}
div.cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  border-radius: 2px;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  border-width: 1px;
  border-style: solid;
  border-color: transparent;
  width: 100%;
  padding: 5px;
  /* This acts as a spacer between cells, that is outside the border */
  margin: 0px;
  outline: none;
  border-left-width: 1px;
  padding-left: 5px;
  background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%);
}
div.cell.jupyter-soft-selected {
  border-left-color: #90CAF9;
  border-left-color: #E3F2FD;
  border-left-width: 1px;
  padding-left: 5px;
  border-right-color: #E3F2FD;
  border-right-width: 1px;
  background: #E3F2FD;
}
@media print {
  div.cell.jupyter-soft-selected {
    border-color: transparent;
  }
}
div.cell.selected {
  border-color: #ababab;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%);
}
@media print {
  div.cell.selected {
    border-color: transparent;
  }
}
div.cell.selected.jupyter-soft-selected {
  border-left-width: 0;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%);
}
.edit_mode div.cell.selected {
  border-color: #66BB6A;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%);
}
@media print {
  .edit_mode div.cell.selected {
    border-color: transparent;
  }
}
.prompt {
  /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */
  min-width: 14ex;
  /* This padding is tuned to match the padding on the CodeMirror editor. */
  padding: 0.4em;
  margin: 0px;
  font-family: monospace;
  text-align: right;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
  /* Don't highlight prompt number selection */
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  /* Use default cursor */
  cursor: default;
}
@media (max-width: 540px) {
  .prompt {
    text-align: left;
  }
}
div.inner_cell {
  min-width: 0;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_area {
  border: 1px solid #cfcfcf;
  border-radius: 2px;
  background: #f7f7f7;
  line-height: 1.21429em;
}
/* This is needed so that empty prompt areas can collapse to zero height when there
   is no content in the output_subarea and the prompt. The main purpose of this is
   to make sure that empty JavaScript output_subareas have no height. */
div.prompt:empty {
  padding-top: 0;
  padding-bottom: 0;
}
div.unrecognized_cell {
  padding: 5px 5px 5px 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.unrecognized_cell .inner_cell {
  border-radius: 2px;
  padding: 5px;
  font-weight: bold;
  color: red;
  border: 1px solid #cfcfcf;
  background: #eaeaea;
}
div.unrecognized_cell .inner_cell a {
  color: inherit;
  text-decoration: none;
}
div.unrecognized_cell .inner_cell a:hover {
  color: inherit;
  text-decoration: none;
}
@media (max-width: 540px) {
  div.unrecognized_cell > div.prompt {
    display: none;
  }
}
div.code_cell {
  /* avoid page breaking on code cells when printing */
}
@media print {
  div.code_cell {
    page-break-inside: avoid;
  }
}
/* any special styling for code cells that are currently running goes here */
div.input {
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.input {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_prompt {
  color: #303F9F;
  border-top: 1px solid transparent;
}
div.input_area > div.highlight {
  margin: 0.4em;
  border: none;
  padding: 0px;
  background-color: transparent;
}
div.input_area > div.highlight > pre {
  margin: 0px;
  border: none;
  padding: 0px;
  background-color: transparent;
}
/* The following gets added to the <head> if it is detected that the user has a
 * monospace font with inconsistent normal/bold/italic height.  See
 * notebookmain.js.  Such fonts will have keywords vertically offset with
 * respect to the rest of the text.  The user should select a better font.
 * See: https://github.com/ipython/ipython/issues/1503
 *
 * .CodeMirror span {
 *      vertical-align: bottom;
 * }
 */
.CodeMirror {
  line-height: 1.21429em;
  /* Changed from 1em to our global default */
  font-size: 14px;
  height: auto;
  /* Changed to auto to autogrow */
  background: none;
  /* Changed from white to allow our bg to show through */
}
.CodeMirror-scroll {
  /*  The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/
  /*  We have found that if it is visible, vertical scrollbars appear with font size changes.*/
  overflow-y: hidden;
  overflow-x: auto;
}
.CodeMirror-lines {
  /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */
  /* we have set a different line-height and want this to scale with that. */
  padding: 0.4em;
}
.CodeMirror-linenumber {
  padding: 0 8px 0 4px;
}
.CodeMirror-gutters {
  border-bottom-left-radius: 2px;
  border-top-left-radius: 2px;
}
.CodeMirror pre {
  /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */
  /* .CodeMirror-lines */
  padding: 0;
  border: 0;
  border-radius: 0;
}
/*

Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org>
Adapted from GitHub theme

*/
.highlight-base {
  color: #000;
}
.highlight-variable {
  color: #000;
}
.highlight-variable-2 {
  color: #1a1a1a;
}
.highlight-variable-3 {
  color: #333333;
}
.highlight-string {
  color: #BA2121;
}
.highlight-comment {
  color: #408080;
  font-style: italic;
}
.highlight-number {
  color: #080;
}
.highlight-atom {
  color: #88F;
}
.highlight-keyword {
  color: #008000;
  font-weight: bold;
}
.highlight-builtin {
  color: #008000;
}
.highlight-error {
  color: #f00;
}
.highlight-operator {
  color: #AA22FF;
  font-weight: bold;
}
.highlight-meta {
  color: #AA22FF;
}
/* previously not defined, copying from default codemirror */
.highlight-def {
  color: #00f;
}
.highlight-string-2 {
  color: #f50;
}
.highlight-qualifier {
  color: #555;
}
.highlight-bracket {
  color: #997;
}
.highlight-tag {
  color: #170;
}
.highlight-attribute {
  color: #00c;
}
.highlight-header {
  color: blue;
}
.highlight-quote {
  color: #090;
}
.highlight-link {
  color: #00c;
}
/* apply the same style to codemirror */
.cm-s-ipython span.cm-keyword {
  color: #008000;
  font-weight: bold;
}
.cm-s-ipython span.cm-atom {
  color: #88F;
}
.cm-s-ipython span.cm-number {
  color: #080;
}
.cm-s-ipython span.cm-def {
  color: #00f;
}
.cm-s-ipython span.cm-variable {
  color: #000;
}
.cm-s-ipython span.cm-operator {
  color: #AA22FF;
  font-weight: bold;
}
.cm-s-ipython span.cm-variable-2 {
  color: #1a1a1a;
}
.cm-s-ipython span.cm-variable-3 {
  color: #333333;
}
.cm-s-ipython span.cm-comment {
  color: #408080;
  font-style: italic;
}
.cm-s-ipython span.cm-string {
  color: #BA2121;
}
.cm-s-ipython span.cm-string-2 {
  color: #f50;
}
.cm-s-ipython span.cm-meta {
  color: #AA22FF;
}
.cm-s-ipython span.cm-qualifier {
  color: #555;
}
.cm-s-ipython span.cm-builtin {
  color: #008000;
}
.cm-s-ipython span.cm-bracket {
  color: #997;
}
.cm-s-ipython span.cm-tag {
  color: #170;
}
.cm-s-ipython span.cm-attribute {
  color: #00c;
}
.cm-s-ipython span.cm-header {
  color: blue;
}
.cm-s-ipython span.cm-quote {
  color: #090;
}
.cm-s-ipython span.cm-link {
  color: #00c;
}
.cm-s-ipython span.cm-error {
  color: #f00;
}
.cm-s-ipython span.cm-tab {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=);
  background-position: right;
  background-repeat: no-repeat;
}
div.output_wrapper {
  /* this position must be relative to enable descendents to be absolute within it */
  position: relative;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  z-index: 1;
}
/* class for the output area when it should be height-limited */
div.output_scroll {
  /* ideally, this would be max-height, but FF barfs all over that */
  height: 24em;
  /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */
  width: 100%;
  overflow: auto;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  display: block;
}
/* output div while it is collapsed */
div.output_collapsed {
  margin: 0px;
  padding: 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
div.out_prompt_overlay {
  height: 100%;
  padding: 0px 0.4em;
  position: absolute;
  border-radius: 2px;
}
div.out_prompt_overlay:hover {
  /* use inner shadow to get border that is computed the same on WebKit/FF */
  -webkit-box-shadow: inset 0 0 1px #000;
  box-shadow: inset 0 0 1px #000;
  background: rgba(240, 240, 240, 0.5);
}
div.output_prompt {
  color: #D84315;
}
/* This class is the outer container of all output sections. */
div.output_area {
  padding: 0px;
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.output_area .MathJax_Display {
  text-align: left !important;
}
div.output_area 
div.output_area 
div.output_area img,
div.output_area svg {
  max-width: 100%;
  height: auto;
}
div.output_area img.unconfined,
div.output_area svg.unconfined {
  max-width: none;
}
/* This is needed to protect the pre formating from global settings such
   as that of bootstrap */
.output {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.output_area {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
div.output_area pre {
  margin: 0;
  padding: 0;
  border: 0;
  vertical-align: baseline;
  color: black;
  background-color: transparent;
  border-radius: 0;
}
/* This class is for the output subarea inside the output_area and after
   the prompt div. */
div.output_subarea {
  overflow-x: auto;
  padding: 0.4em;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
  max-width: calc(100% - 14ex);
}
div.output_scroll div.output_subarea {
  overflow-x: visible;
}
/* The rest of the output_* classes are for special styling of the different
   output types */
/* all text output has this class: */
div.output_text {
  text-align: left;
  color: #000;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
}
/* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */
div.output_stderr {
  background: #fdd;
  /* very light red background for stderr */
}
div.output_latex {
  text-align: left;
}
/* Empty output_javascript divs should have no height */
div.output_javascript:empty {
  padding: 0;
}
.js-error {
  color: darkred;
}
/* raw_input styles */
div.raw_input_container {
  line-height: 1.21429em;
  padding-top: 5px;
}
pre.raw_input_prompt {
  /* nothing needed here. */
}
input.raw_input {
  font-family: monospace;
  font-size: inherit;
  color: inherit;
  width: auto;
  /* make sure input baseline aligns with prompt */
  vertical-align: baseline;
  /* padding + margin = 0.5em between prompt and cursor */
  padding: 0em 0.25em;
  margin: 0em 0.25em;
}
input.raw_input:focus {
  box-shadow: none;
}
p.p-space {
  margin-bottom: 10px;
}
div.output_unrecognized {
  padding: 5px;
  font-weight: bold;
  color: red;
}
div.output_unrecognized a {
  color: inherit;
  text-decoration: none;
}
div.output_unrecognized a:hover {
  color: inherit;
  text-decoration: none;
}
.rendered_html {
  color: #000;
  /* any extras will just be numbers: */
}



.rendered_html :link {
  text-decoration: underline;
}
.rendered_html :visited {
  text-decoration: underline;
}






.rendered_html h1:first-child {
  margin-top: 0.538em;
}
.rendered_html h2:first-child {
  margin-top: 0.636em;
}
.rendered_html h3:first-child {
  margin-top: 0.777em;
}
.rendered_html h4:first-child {
  margin-top: 1em;
}
.rendered_html h5:first-child {
  margin-top: 1em;
}
.rendered_html h6:first-child {
  margin-top: 1em;
}








.rendered_html * + ul {
  margin-top: 1em;
}
.rendered_html * + ol {
  margin-top: 1em;
}


.rendered_html pre,



.rendered_html tr,
.rendered_html th,

.rendered_html td,


.rendered_html * + table {
  margin-top: 1em;
}

.rendered_html * + p {
  margin-top: 1em;
}

.rendered_html * + img {
  margin-top: 1em;
}
.rendered_html img,

.rendered_html img.unconfined,

div.text_cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.text_cell > div.prompt {
    display: none;
  }
}
div.text_cell_render {
  /*font-family: "Helvetica Neue", Arial, Helvetica, Geneva, sans-serif;*/
  outline: none;
  resize: none;
  width: inherit;
  border-style: none;
  padding: 0.5em 0.5em 0.5em 0.4em;
  color: #000;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
}
a.anchor-link:link {
  text-decoration: none;
  padding: 0px 20px;
  visibility: hidden;
}
h1:hover .anchor-link,
h2:hover .anchor-link,
h3:hover .anchor-link,
h4:hover .anchor-link,
h5:hover .anchor-link,
h6:hover .anchor-link {
  visibility: visible;
}
.text_cell.rendered .input_area {
  display: none;
}
.text_cell.rendered 
.text_cell.unrendered .text_cell_render {
  display: none;
}
.cm-header-1,
.cm-header-2,
.cm-header-3,
.cm-header-4,
.cm-header-5,
.cm-header-6 {
  font-weight: bold;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}
.cm-header-1 {
  font-size: 185.7%;
}
.cm-header-2 {
  font-size: 157.1%;
}
.cm-header-3 {
  font-size: 128.6%;
}
.cm-header-4 {
  font-size: 110%;
}
.cm-header-5 {
  font-size: 100%;
  font-style: italic;
}
.cm-header-6 {
  font-size: 100%;
  font-style: italic;
}
</style>
<style type="text/css">.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>
<style type="text/css">
/* Temporary definitions which will become obsolete with Notebook release 5.0 */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="experiencor/keras-yolo2's-YOLO-V2-loss"><a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss<a class="anchor-link" href="#experiencor/keras-yolo2's-YOLO-V2-loss">¶</a></h3><p><img alt="YOLO v2 loss funciton" height="570" src="https://farm8.staticflickr.com/7904/45592720625_821897e898_b.jpg" width="1024" /></a></p>
<p>This is the fourth blog post of <a href="https://fairyonice.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection with YOLO blog series</a>. 
This blog discusses the YOLO's loss funciton. This will be the most intense blog post in <a href="https://fairyonice.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection with YOLO blog series</a>. as loss function of YOLO is quite complex. So please get excited! 
For demonstration of the code, I will agian use PASCAL VOC2012 data. 
This blog assumes that the readers have read the previous two blog posts - <a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1</a>, <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2</a> and <a href="https://fairyonice.github.io/Part_3_Object_Detection_with_Yolo_using_VOC_2012_data_model.html">Part 3</a>.</p>
<h2 id="Andrew-Ng's-YOLO-lecture">Andrew Ng's YOLO lecture<a class="anchor-link" href="#Andrew-Ng's-YOLO-lecture">¶</a></h2><ul>
<li><a href="https://www.youtube.com/watch?v=gKreZOUi-O0&amp;t=0s&amp;index=7&amp;list=PL_IHmaMAvkVxdDOBRg2CbcJBq9SY7ZUvs">Neural Networks - Bounding Box Predictions</a></li>
<li><a href="https://www.youtube.com/watch?v=ANIzQ5G-XPE&amp;t=7s">C4W3L06 Intersection Over Union</a></li>
<li><a href="https://www.youtube.com/watch?v=VAo84c1hQX8&amp;t=192s">C4W3L07 Nonmax Suppression</a></li>
<li><a href="https://www.youtube.com/watch?v=RTlwl2bv0Tg&amp;t=28s">C4W3L08 Anchor Boxes</a></li>
<li><a href="https://www.youtube.com/watch?v=9s_FpMpdYW8&amp;t=34s">C4W3L09 YOLO Algorithm</a></li>
</ul>
<h2 id="Reference">Reference<a class="anchor-link" href="#Reference">¶</a></h2><ul>
<li><p><a href="https://arxiv.org/pdf/1506.02640.pdf">You Only Look Once:Unified, Real-Time Object Detection</a></p>
</li>
<li><p><a href="https://arxiv.org/pdf/1612.08242.pdf">YOLO9000:Better, Faster, Stronger</a></p>
</li>
<li><p><a href="https://github.com/experiencor/keras-yolo2">experiencor/keras-yolo2</a></p>
</li>
</ul>
<h2 id="Reference-in-my-blog">Reference in my blog<a class="anchor-link" href="#Reference-in-my-blog">¶</a></h2><ul>
<li><a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1 Object Detection using YOLOv2 on Pascal VOC2012 - anchor box clustering</a></li>
<li><a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a></li>
<li><a href="https://fairyonice.github.io/Part_3_Object_Detection_with_Yolo_using_VOC_2012_data_model.html">Part 3 Object Detection using YOLOv2 on Pascal VOC2012 - model</a></li>
<li><a href="https://fairyonice.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html">Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss</a></li>
<li><a href="https://fairyonice.github.io/Part_5_Object_Detection_with_Yolo_using_VOC_2012_data_training.html">Part 5 Object Detection using YOLOv2 on Pascal VOC2012 - training</a></li>
<li><a href="https://fairyonice.github.io/Part_6_Object_Detection_with_Yolo_using_VOC_2012_data_inference_image.html">Part 6 Object Detection using YOLOv2 on Pascal VOC 2012 data - inference on image</a></li>
<li><a href="https://fairyonice.github.io/Part_6_Object_Detection_with_Yolo_using_VOC_2012_data_inference_video.html">Part 7 Object Detection using YOLOv2 on Pascal VOC 2012 data - inference on video</a></li>
</ul>
<h2 id="My-GitHub-repository">My GitHub repository<a class="anchor-link" href="#My-GitHub-repository">¶</a></h2><p>This repository contains all the ipython notebooks in this blog series and the funcitons (See backend.py).</p>
<ul>
<li><a href="https://github.com/FairyOnIce/ObjectDetectionYolo">FairyOnIce/ObjectDetectionYolo</a></li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [41]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>3.6.3 |Anaconda, Inc.| (default, Oct  6 2017, 12:04:38) 
[GCC 4.2.1 Compatible Clang 4.0.1 (tags/RELEASE_401/final)]
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Define-anchor-box">Define anchor box<a class="anchor-link" href="#Define-anchor-box">¶</a></h2><p><code>ANCHORS</code> defines the number of anchor boxes and the shape of each anchor box.
The choice of the anchor box specialization is already discussed in <a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1 Object Detection using YOLOv2 on Pascal VOC2012 - anchor box clustering</a>.</p>
<p>Based on the K-means analysis in the previous blog post, I will select 4 anchor boxes of following width and height. The width and heights are rescaled in the grid cell scale (Assuming that the number of grid size is 13 by 13.) See <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a> to learn how I rescal the anchor box shapes into the grid cell scale.</p>
<p>Here I choose 4 anchor boxes. With 13 by 13 grids, every frame gets 4 x 13 x 13 = 676 bouding box predictions.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [42]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ANCHORS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.07709888</span><span class="p">,</span>  <span class="mf">1.78171903</span><span class="p">,</span>  <span class="c1"># anchor box 1, width , height</span>
                    <span class="mf">2.71054693</span><span class="p">,</span>  <span class="mf">5.12469308</span><span class="p">,</span>  <span class="c1"># anchor box 2, width,  height</span>
                   <span class="mf">10.47181473</span><span class="p">,</span> <span class="mf">10.09646365</span><span class="p">,</span>  <span class="c1"># anchor box 3, width,  height</span>
                    <span class="mf">5.48531347</span><span class="p">,</span>  <span class="mf">8.11011331</span><span class="p">])</span> <span class="c1"># anchor box 4, width,  height</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Define-Label-vector-containing-20-object-classe-names.">Define Label vector containing 20 object classe names.<a class="anchor-link" href="#Define-Label-vector-containing-20-object-classe-names.">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [43]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LABELS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'aeroplane'</span><span class="p">,</span>  <span class="s1">'bicycle'</span><span class="p">,</span> <span class="s1">'bird'</span><span class="p">,</span>  <span class="s1">'boat'</span><span class="p">,</span>      <span class="s1">'bottle'</span><span class="p">,</span> 
          <span class="s1">'bus'</span><span class="p">,</span>        <span class="s1">'car'</span><span class="p">,</span>      <span class="s1">'cat'</span><span class="p">,</span>  <span class="s1">'chair'</span><span class="p">,</span>     <span class="s1">'cow'</span><span class="p">,</span>
          <span class="s1">'diningtable'</span><span class="p">,</span><span class="s1">'dog'</span><span class="p">,</span>    <span class="s1">'horse'</span><span class="p">,</span>  <span class="s1">'motorbike'</span><span class="p">,</span> <span class="s1">'person'</span><span class="p">,</span>
          <span class="s1">'pottedplant'</span><span class="p">,</span><span class="s1">'sheep'</span><span class="p">,</span>  <span class="s1">'sofa'</span><span class="p">,</span>   <span class="s1">'train'</span><span class="p">,</span>   <span class="s1">'tvmonitor'</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="YOLOv2's-loss-function">YOLOv2's loss function<a class="anchor-link" href="#YOLOv2's-loss-function">¶</a></h1><p>Before discussing the loss function, I will read in VOC2012 data, and call the batch generator in order to use the example batch <code> [x_batch,b_batch],y_batch</code> to demonstrate the usage of the loss funciton.</p>
<h3 id="Read-images-and-annotations-into-memory">Read images and annotations into memory<a class="anchor-link" href="#Read-images-and-annotations-into-memory">¶</a></h3><p>Use the pre-processing code for parsing annotation at <a href="https://github.com/experiencor/keras-yolo2">experiencor/keras-yolo2</a>.
This <code>parse_annoation</code> function is already used in <a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1 Object Detection using YOLOv2 on Pascal VOC2012 - anchor box clustering</a> and saved in my python script. 
This script can be downloaded at <a href="https://github.com/FairyOnIce/ObjectDetectionYolo/blob/master/backend.py">my Github repository, FairyOnIce/ObjectDetectionYolo/backend</a>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [44]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">### The location where the VOC2012 data is saved.</span>
<span class="n">train_image_folder</span> <span class="o">=</span> <span class="s2">"../ObjectDetectionRCNN/VOCdevkit/VOC2012/JPEGImages/"</span>
<span class="n">train_annot_folder</span> <span class="o">=</span> <span class="s2">"../ObjectDetectionRCNN/VOCdevkit/VOC2012/Annotations/"</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">backend</span> <span class="k">import</span> <span class="n">parse_annotation</span>
<span class="n">train_image</span><span class="p">,</span> <span class="n">seen_train_labels</span> <span class="o">=</span> <span class="n">parse_annotation</span><span class="p">(</span><span class="n">train_annot_folder</span><span class="p">,</span>
                                                  <span class="n">train_image_folder</span><span class="p">,</span> 
                                                  <span class="n">labels</span><span class="o">=</span><span class="n">LABELS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"N train = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_image</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>N train = 17125
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Instantiate-batch-generator-object">Instantiate batch generator object<a class="anchor-link" href="#Instantiate-batch-generator-object">¶</a></h3><p><code>SimpleBatchGenerator</code> is discussed and used in 
<a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a>.
This script can be downloaded at <a href="https://github.com/FairyOnIce/ObjectDetectionYolo/blob/master/backend.py">my Github repository, FairyOnIce/ObjectDetectionYolo/backend</a>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [45]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">backend</span> <span class="k">import</span> <span class="n">SimpleBatchGenerator</span>

<span class="n">BATCH_SIZE</span>        <span class="o">=</span> <span class="mi">200</span>
<span class="n">IMAGE_H</span><span class="p">,</span> <span class="n">IMAGE_W</span>  <span class="o">=</span> <span class="mi">416</span><span class="p">,</span> <span class="mi">416</span>
<span class="n">GRID_H</span><span class="p">,</span>  <span class="n">GRID_W</span>   <span class="o">=</span> <span class="mi">13</span> <span class="p">,</span> <span class="mi">13</span>
<span class="n">TRUE_BOX_BUFFER</span>   <span class="o">=</span> <span class="mi">50</span>
<span class="n">BOX</span>               <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># CLASS             = len(LABELS)</span>

<span class="n">generator_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'IMAGE_H'</span>         <span class="p">:</span> <span class="n">IMAGE_H</span><span class="p">,</span> 
    <span class="s1">'IMAGE_W'</span>         <span class="p">:</span> <span class="n">IMAGE_W</span><span class="p">,</span>
    <span class="s1">'GRID_H'</span>          <span class="p">:</span> <span class="n">GRID_H</span><span class="p">,</span>  
    <span class="s1">'GRID_W'</span>          <span class="p">:</span> <span class="n">GRID_W</span><span class="p">,</span>
    <span class="s1">'LABELS'</span>          <span class="p">:</span> <span class="n">LABELS</span><span class="p">,</span>
    <span class="s1">'ANCHORS'</span>         <span class="p">:</span> <span class="n">ANCHORS</span><span class="p">,</span>
    <span class="s1">'BATCH_SIZE'</span>      <span class="p">:</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
    <span class="s1">'TRUE_BOX_BUFFER'</span> <span class="p">:</span> <span class="n">TRUE_BOX_BUFFER</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">image</span> <span class="o">/</span> <span class="mf">255.</span>
<span class="n">train_batch_generator</span> <span class="o">=</span> <span class="n">SimpleBatchGenerator</span><span class="p">(</span><span class="n">train_image</span><span class="p">,</span> <span class="n">generator_config</span><span class="p">,</span>
                                             <span class="n">norm</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="p">[</span><span class="n">x_batch</span><span class="p">,</span><span class="n">b_batch</span><span class="p">],</span><span class="n">y_batch</span> <span class="o">=</span> <span class="n">train_batch_generator</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Calculating-YOLOv2's-loss-function">Calculating YOLOv2's loss function<a class="anchor-link" href="#Calculating-YOLOv2's-loss-function">¶</a></h1><p>I have seen a lot of online blog posts about YOLO v1 loss function.
For example, at <a href="https://hackernoon.com/understanding-yolo-f5a74bbc7967">Understanding YOLO</a>.
However, most of these posts discusses the loss function of Yolo v1 which must be different from Yolo v2.
The two losses are different and the lack of explicit formula in the Yolo v2 loss paper rises some confusion, for example at <a href="https://groups.google.com/forum/#!topic/darknet/TJ4dN9R4iJk">What is YOLOv2 Loss Function - Google Groups</a>.</p>
<p>The YOLO v1 is difined in 
<a href="https://arxiv.org/pdf/1506.02640.pdf">You Only Look Once:Unified, Real-Time Object Detection</a> as:</p>
<h3 id="YOLO-V1-loss">YOLO V1 loss<a class="anchor-link" href="#YOLO-V1-loss">¶</a></h3><p>$$\begin{array}{rl}
&\lambda_\textbf{coord}
\sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
     L_{ij}^{\text{obj}}
            \left[
            \left(
                x_i - \hat{x}_i
            \right)^2 +
            \left(
                y_i - \hat{y}_i
            \right)^2
            \right]
\\
&+ \lambda_\textbf{coord} 
\sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
         L_{ij}^{\text{obj}}
         \left[
        \left(
            \sqrt{w_i} - \sqrt{\hat{w}_i}
        \right)^2 +
        \left(
            \sqrt{h_i} - \sqrt{\hat{h}_i}
        \right)^2
        \right]
\\
&+ \sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
        L_{ij}^{\text{obj}}
        \left(
            C_i - \hat{C}_i
        \right)^2
\\
&+ \lambda_\textrm{noobj}
\sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
    L_{ij}^{\text{noobj}}
        \left(
            C_i - \hat{C}_i
        \right)^2
\\
&+ \sum_{i = 0}^{S^2}
L_i^{\text{obj}}
    \sum_{c \in \textrm{classes}}
        \left(
            p_i(c) - \hat{p}_i(c)
        \right)^2
\end{array}$$</p>
<p>YOLOv2 paper expalins the difference in architecture from YOLOv1 as follows:</p>
<blockquote>
We remove the fully connected layers from YOLO(v1) and use anchor boxes to predict bounding boxes...
When we move to anchor boxes we also decouple the class prediction mechanism from the spatial location and instead predict class and objectness for every anchorbox. 
</blockquote><p>This means that the confidence probability $p_i(c)$ above should depend not only on $i$ and $c$ but also an anchor box index, say $j$. Therefore, the loss needs to be different from above. Unfortunately, YOLOv2 paper does not explicitly state its loss function. So rather than making a guess based on the paper, I will try to understand the loss function that <a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a> defines for his YOLOv2.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="experiencor/keras-yolo2's-YOLO-V2-loss"><a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss<a class="anchor-link" href="#experiencor/keras-yolo2's-YOLO-V2-loss">¶</a></h3><p>In <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a>, I showed that YOLO's output is encoded into <code>y_batch</code>.</p>
<p>Here I revisit YOLO's ground truth output encoding with mathematical notations.</p>
<p><code>
y_batch
</code></p>
<p>The numpy array of shape  <code>(BATCH_SIZE, GRID_H, GRID_W, BOX, 4 + 1 + N classes) </code>.</p>
<p>BOX = The number of anchor boxes.</p>
<p>In the following notation, the grid cell index can be defined by two index (<code>igrid_h</code>,<code>igrid_w</code>) or by a single index $i$; (<code>igrid_h</code>,<code>igrid_w</code>) $\leftrightarrow i$</p>
<ul>
<li><p><code>y_batch[iframe,igrid_h,igrid_w,j,:4]</code> contains <code>(center_x,center_y,center_w,center_h)</code> of <code>j</code>th anchor at <code>grid cell=(igrid_h,igrid_w)</code> = $i$, 
  if the object exists in this (grid cell, anchor) pair, else they simply contain 0.</p>
<p><code>y_batch[iframe,igrid_h,igrid_w,j,:4]</code>$= (x_{i,\texttt{j}},y_{i,\texttt{j}},w_{i,\texttt{j}},h_{i,\texttt{j}})$</p>
</li>
</ul>
<ul>
<li><p><code>y_batch[iframe,igrid_h,igrid_w,j,4]</code> 
  contains 1 if the object exists in this (grid cell, anchor) pair, else it contains 0.</p>
<p><code>y_batch[iframe,igrid_h,igrid_w,j,4]</code> = $ C_{i,\texttt{j}}$</p>
</li>
</ul>
<ul>
<li><p><code>y_batch[iframe,igrid_h,igrid_w,j,5 + iclass]</code> contains 1 if the <code>iclass</code>th class object exists in this (grid cell, anchor) pair, else it contains 0.</p>
<p><code>y_batch[iframe,igrid_h,igrid_w,j,5:]</code> $ = (p^1_{i,\texttt{j}},p^2_{i,\texttt{j}},p^3_{i,\texttt{j}},\cdots,p^{\textrm{Nclass}}_{i,\texttt{j}})$</p>
</li>
</ul>
<p>The loss function of YOLO treats each set of elements 
<code>(center_x,center_y,center_w,center_h)</code>, 
<code>C</code>, and 
<code>(p_1,p_2,...p_Nclass)</code> in <code>y_batch[iframe,igrid_h,igrid_w,:]</code> differently. So let's understand each term of the loss one by one.</p>
<p>Then the loss corresponding to (grid cell, anchor box) pair = ($i,j$) is calculated as:</p>
<p>$$\small
%%%
\begin{array}{rl}\small
\textrm{loss}_{i,j} &= \textrm{loss}_{i,j}^{xywh} +  \textrm{loss}_{i,j}^p + \textrm{loss}_{i,j}^c \\
%%%
\textrm{loss}_{i,j}^{xywh}&=
\frac{\lambda_{\textrm{coord}}}{N_{L^{obj}}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\big[
\left(x_{i,j}-\hat{x}_{i,j}\right)^2 + 
\left(y_{i,j}-\hat{y}_{i,j}\right)^2 +\\
&\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\left(\sqrt{w}_{i,j}-\sqrt{\hat{w}}_{i,j}\right)^2 +
\left(\sqrt{h}_{i,j}-\sqrt{\hat{h}}_{i,j}\right)^2 
\big]\\
%%%
\textrm{loss}_{i,j}^p&=
-\frac{\lambda_{\text{class}}}{N_{L^{obj}}}
\sum_{i=0}^{S^2} \sum_{j=0}^B L_{i,j}^{\text{obj}}
\sum_{c \in \text{class}}  p_{i,j}^c \text{log}(\hat{p}_{i,j}^c)\\
%%%
\textrm{loss}_{i,j}^c &=
\frac{\lambda_{\text{obj}}}{N^{conf}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\left(
IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} - \widehat{C}_{i,j}
\right)^2\\
&\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;+
\frac{\lambda_{\textrm{noobj}}}{N^{conf}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{noobj}}
\left(0 - \widehat{C}_{i,j}\right)\\
\end{array}
$$</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>where:</p>
<ul>
<li>$N_{L^{obj}} = \sum_{i=0}^{S^2}
\sum_{j=0}^B L_{i,j}^{\text{obj}}$</li>
<li><p>$N^{conf} =  \sum_{i=0}^{S^2}
\sum_{j=0}^B L_{i,j}^{\text{obj}} + L_{i,j}^{\text{noobj}}(1-L_{i,j}^{\text{obj}})$</p>
</li>
<li><p>$\text{preduiction}_{i,j}=(\hat{x}_{i,j},\hat{y}_{i,j},\hat{w}_{i,j},\hat{h}_{i,j})$</p>
</li>
<li>$\text{ground truth}_{i,j}=(x_{i,j},y_{i,j},w_{i,j},h_{i,j})$</li>
<li>$\lambda_{\text{coord}}$, $\lambda_{\text{class}}$ and $\lambda_{\text{noobj}}$ are scalars to weight each loss funciton </li>
</ul>
<p>Here, $L_{i,j}^{\text{noobj}}$ and $L_{i,j}^{\text{obj}}$ are 0/1 indicator function such that:
$$
\begin{array}{rl}
L_{i,j}^{\text{obj}}
 &= 
 \begin{cases}
 1 
\;\;\text{if} \;\;C_{i,j}=1\\
 0\;\;\text{else}\\
\end{cases}\\
L_{i,j}^{\text{noobj}}
& = 
\begin{cases}
 1 \;\;\text{if}\;\;\text{max}_{i',j'}
 \;\;IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i',j'}} < 0.6 \;\text{and}\; C_{i,j} = 0\\
 0\;\;\text{else}\\
\end{cases}\\
\end{array}
$$</p>
<p>As the loss function seems complex, let's go over the  <a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss function line by line.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Global-hyperparameters-necessary-for-the-loss-function">Global hyperparameters necessary for the loss function<a class="anchor-link" href="#Global-hyperparameters-necessary-for-the-loss-function">¶</a></h3>
<pre><code>               -  true_boxes
               -  GRID_W
               -  GRID_H
               -  BATCH_SIZE
               -  ANCHORS
               -  LAMBDA_COORD
               -  LAMBDA_CLASS
               -  LAMBDA_NO_OBJECT 
               -  LAMBDA_OBJECT</code></pre>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [46]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LAMBDA_NO_OBJECT</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">LAMBDA_OBJECT</span>    <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">LAMBDA_COORD</span>     <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">LAMBDA_CLASS</span>     <span class="o">=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-1:-Adjust-prediction-output">Step 1: Adjust prediction output<a class="anchor-link" href="#Step-1:-Adjust-prediction-output">¶</a></h3><p><a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss function starts off by rescaling the prediction output. 
Notice that the predicted y_batch output can take any real values as the conv_23 layer has a linear activation function. However, the prediction outputs should be rescaled in the following range:</p>
<ol>
<li>$\hat{x}_{i,j}$ ranges between [<code>igrid_w,igrid_w+1</code>).</li>
<li>$\hat{y}_{i,j}$ ranges between [<code>igrid_h,igrid_h+1</code>)</li>
<li>$\hat{w}_{i,j}$ ranges between 0, GRID_W</li>
<li>$\hat{h}_{i,j}$ ranges between 0, GRID_H</li>
<li>$\widehat{C}_{i,j}$ ranges between 0 and 1. </li>
<li>$\widehat{p^c}_{i,j}$ ranges between 0 and 1</li>
</ol>
<p>The 1, 2, 3 and 4 are because the bounding boxes are in grid cell scale. See Bounding box encoding Section in 
  <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [47]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_cell_grid</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">BOX</span><span class="p">):</span> 
    <span class="sd">'''</span>
<span class="sd">    Helper function to assure that the bounding box x and y are in the grid cell scale</span>
<span class="sd">    == output == </span>
<span class="sd">    for any i=0,1..,batch size - 1</span>
<span class="sd">    output[i,5,3,:,:] = array([[3., 5.],</span>
<span class="sd">                               [3., 5.],</span>
<span class="sd">                               [3., 5.]], dtype=float32)</span>
<span class="sd">    '''</span>
    <span class="c1">## cell_x.shape = (1, 13, 13, 1, 1)</span>
    <span class="c1">## cell_x[:,i,j,:] = [[[j]]]</span>
    <span class="n">cell_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">),</span> <span class="p">[</span><span class="n">GRID_H</span><span class="p">]),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GRID_H</span><span class="p">,</span> <span class="n">GRID_W</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="c1">## cell_y.shape = (1, 13, 13, 1, 1)</span>
    <span class="c1">## cell_y[:,i,j,:] = [[[i]]]</span>
    <span class="n">cell_y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cell_x</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="c1">## cell_gird.shape = (16, 13, 13, 5, 2)</span>
    <span class="c1">## for any n, k, i, j</span>
    <span class="c1">##    cell_grid[n, i, j, anchor, k] = j when k = 0</span>
    <span class="c1">## for any n, k, i, j</span>
    <span class="c1">##    cell_grid[n, i, j, anchor, k] = i when k = 1    </span>
    <span class="n">cell_grid</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cell_x</span><span class="p">,</span><span class="n">cell_y</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BOX</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">cell_grid</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">adjust_scale_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">cell_grid</span><span class="p">,</span> <span class="n">ANCHORS</span><span class="p">):</span>    
    <span class="sd">"""</span>
<span class="sd">        Adjust prediction</span>
<span class="sd">        </span>
<span class="sd">        == input ==</span>
<span class="sd">        </span>
<span class="sd">        y_pred : takes any real values</span>
<span class="sd">                 tensor of shape = (N batch, NGrid h, NGrid w, NAnchor, 4 + 1 + N class)</span>
<span class="sd">        </span>
<span class="sd">        ANCHORS : list containing width and height specializaiton of anchor box</span>
<span class="sd">        == output ==</span>
<span class="sd">        </span>
<span class="sd">        pred_box_xy : shape = (N batch, N grid x, N grid y, N anchor, 2), contianing [center_y, center_x] rangining [0,0]x[grid_H-1,grid_W-1]</span>
<span class="sd">          pred_box_xy[irow,igrid_h,igrid_w,ianchor,0] =  center_x</span>
<span class="sd">          pred_box_xy[irow,igrid_h,igrid_w,ianchor,1] =  center_1</span>
<span class="sd">          </span>
<span class="sd">          calculation process:</span>
<span class="sd">          tf.sigmoid(y_pred[...,:2]) : takes values between 0 and 1</span>
<span class="sd">          tf.sigmoid(y_pred[...,:2]) + cell_grid : takes values between 0 and grid_W - 1 for x coordinate </span>
<span class="sd">                                                   takes values between 0 and grid_H - 1 for y coordinate </span>
<span class="sd">                                                   </span>
<span class="sd">        pred_Box_wh : shape = (N batch, N grid h, N grid w, N anchor, 2), containing width and height, rangining [0,0]x[grid_H-1,grid_W-1]</span>
<span class="sd">        </span>
<span class="sd">        pred_box_conf : shape = (N batch, N grid h, N grid w, N anchor, 1), containing confidence to range between 0 and 1</span>
<span class="sd">        </span>
<span class="sd">        pred_box_class : shape = (N batch, N grid h, N grid w, N anchor, N class), containing </span>
<span class="sd">    """</span>
    <span class="n">BOX</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1">## cell_grid is of the shape of </span>
    
    <span class="c1">### adjust x and y  </span>
    <span class="c1"># the bounding box bx and by are rescaled to range between 0 and 1 for given gird.</span>
    <span class="c1"># Since there are BOX x BOX grids, we rescale each bx and by to range between 0 to BOX + 1</span>
    <span class="n">pred_box_xy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">cell_grid</span> <span class="c1"># bx, by</span>
    
    <span class="c1">### adjust w and h</span>
    <span class="c1"># exp to make width and height positive</span>
    <span class="c1"># rescale each grid to make some anchor "good" at representing certain shape of bounding box </span>
    <span class="n">pred_box_wh</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">BOX</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># bw, bh</span>

    <span class="c1">### adjust confidence </span>
    <span class="n">pred_box_conf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span><span class="c1"># prob bb</span>

    <span class="c1">### adjust class probabilities </span>
    <span class="n">pred_box_class</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">5</span><span class="p">:]</span> <span class="c1"># prC1, prC2, ..., prC20</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">,</span><span class="n">pred_box_conf</span><span class="p">,</span><span class="n">pred_box_class</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-adjust_scale_prediction">Experiment <code>adjust_scale_prediction</code><a class="anchor-link" href="#Experiment-adjust_scale_prediction">¶</a></h4><p>I generate the real valued y_pred before rescaling from Normal(mean=0,sd = const/(GRID_H*GRID_W)), as this will be my weight initializer for the layer 23 when const = 1. I will set const = 10 to make the distribution variance a bit larger.</p>
<p>The bounding box parameters x, y, w, h and confidence are in the expected range. 
However, the class probabilities can take negative values. This is ok because the loss function later applies  softmax to <code>y_pred[:,:,:,:,5:]</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [48]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">print_min_max</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">title</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">{}</span><span class="s2"> MIN=</span><span class="si">{:5.2f}</span><span class="s2">, MAX=</span><span class="si">{:5.2f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">title</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vec</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"prepare inputs"</span><span class="p">)</span>
<span class="n">GRID_W</span> <span class="o">=</span> <span class="mi">13</span> 
<span class="n">GRID_H</span> <span class="o">=</span> <span class="mi">13</span> 
<span class="n">BOX</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">CLASS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LABELS</span><span class="p">)</span>
<span class="n">size</span>   <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="o">*</span><span class="n">GRID_W</span><span class="o">*</span><span class="n">GRID_H</span><span class="o">*</span><span class="n">BOX</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">CLASS</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">10</span><span class="o">/</span><span class="p">(</span><span class="n">GRID_H</span><span class="o">*</span><span class="n">GRID_W</span><span class="p">))</span> 
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">BOX</span><span class="p">,</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">CLASS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"y_pred before scaling = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"define tensor graph"</span><span class="p">)</span>
<span class="n">y_pred_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="n">cell_grid</span> <span class="o">=</span> <span class="n">get_cell_grid</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">BOX</span><span class="p">)</span>
<span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">,</span>   <span class="n">pred_box_wh_tf</span><span class="p">,</span> 
 <span class="n">pred_box_conf_tf</span><span class="p">,</span> <span class="n">pred_box_class_tf</span><span class="p">)</span> <span class="o">=</span> <span class="n">adjust_scale_prediction</span><span class="p">(</span><span class="n">y_pred_tf</span><span class="p">,</span> 
                                                                <span class="n">cell_grid</span><span class="p">,</span> 
                                                                <span class="n">ANCHORS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span>   <span class="n">pred_box_wh</span><span class="p">,</span> 
     <span class="n">pred_box_conf</span><span class="p">,</span> <span class="n">pred_box_class</span><span class="p">)</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pred_box_xy_tf</span><span class="p">,</span>   <span class="n">pred_box_wh_tf</span><span class="p">,</span>
         <span class="n">pred_box_conf_tf</span><span class="p">,</span> <span class="n">pred_box_class_tf</span><span class="p">])</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_xy </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>           
<span class="k">for</span> <span class="n">igrid_w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">[:,:,</span><span class="n">igrid_w</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                      <span class="s2">"  bounding box x at iGRID_W=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_w</span><span class="p">))</span>
<span class="k">for</span> <span class="n">igrid_h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">[:,</span><span class="n">igrid_h</span><span class="p">,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                  <span class="s2">"  bounding box y at iGRID_H=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_h</span><span class="p">))</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_wh </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box width "</span><span class="p">)</span> 
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box height"</span><span class="p">)</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_conf </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_conf</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_conf</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  confidence "</span><span class="p">)</span> 

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_class </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_class</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_class</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  class probability"</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
prepare inputs
y_pred before scaling = (200, 13, 13, 4, 25)
******************************
define tensor graph
******************************
ouput
******************************

pred_box_xy (200, 13, 13, 4, 2)
  bounding box x at iGRID_W=00 MIN= 0.44, MAX= 0.55
  bounding box x at iGRID_W=01 MIN= 1.44, MAX= 1.55
  bounding box x at iGRID_W=02 MIN= 2.44, MAX= 2.56
  bounding box x at iGRID_W=03 MIN= 3.43, MAX= 3.56
  bounding box x at iGRID_W=04 MIN= 4.45, MAX= 4.56
  bounding box x at iGRID_W=05 MIN= 5.44, MAX= 5.56
  bounding box x at iGRID_W=06 MIN= 6.44, MAX= 6.56
  bounding box x at iGRID_W=07 MIN= 7.44, MAX= 7.56
  bounding box x at iGRID_W=08 MIN= 8.45, MAX= 8.56
  bounding box x at iGRID_W=09 MIN= 9.45, MAX= 9.55
  bounding box x at iGRID_W=10 MIN=10.45, MAX=10.55
  bounding box x at iGRID_W=11 MIN=11.45, MAX=11.56
  bounding box x at iGRID_W=12 MIN=12.44, MAX=12.56
  bounding box y at iGRID_H=00 MIN= 0.44, MAX= 0.56
  bounding box y at iGRID_H=01 MIN= 1.45, MAX= 1.56
  bounding box y at iGRID_H=02 MIN= 2.44, MAX= 2.56
  bounding box y at iGRID_H=03 MIN= 3.45, MAX= 3.57
  bounding box y at iGRID_H=04 MIN= 4.44, MAX= 4.55
  bounding box y at iGRID_H=05 MIN= 5.44, MAX= 5.55
  bounding box y at iGRID_H=06 MIN= 6.44, MAX= 6.56
  bounding box y at iGRID_H=07 MIN= 7.45, MAX= 7.55
  bounding box y at iGRID_H=08 MIN= 8.45, MAX= 8.55
  bounding box y at iGRID_H=09 MIN= 9.44, MAX= 9.56
  bounding box y at iGRID_H=10 MIN=10.44, MAX=10.55
  bounding box y at iGRID_H=11 MIN=11.44, MAX=11.56
  bounding box y at iGRID_H=12 MIN=12.44, MAX=12.56

pred_box_wh (200, 13, 13, 4, 2)
  bounding box width  MIN= 0.81, MAX=13.47
  bounding box height MIN= 1.37, MAX=12.69

pred_box_conf (200, 13, 13, 4)
  confidence  MIN= 0.43, MAX= 0.56

pred_box_class (200, 13, 13, 4, 20)
  class probability MIN=-0.30, MAX= 0.29
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-2:-Extract-ground-truth-output">Step 2: Extract ground truth output<a class="anchor-link" href="#Step-2:-Extract-ground-truth-output">¶</a></h3><p>Extraction of the ground truth output is simpler than the extraction of the prediction output because the ground truth is already encoded in the correct scales.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [49]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">extract_ground_truth</span><span class="p">(</span><span class="n">y_true</span><span class="p">):</span>    
    <span class="n">true_box_xy</span>    <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># bounding box x, y coordinate in grid cell scale </span>
    <span class="n">true_box_wh</span>    <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># number of cells accross, horizontally and vertically</span>
    <span class="n">true_box_conf</span>  <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>    <span class="c1"># confidence </span>
    <span class="n">true_box_class</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">5</span><span class="p">:],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_class</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-extract_ground_truth">Experiment <code>extract_ground_truth</code><a class="anchor-link" href="#Experiment-extract_ground_truth">¶</a></h4><p>The scales of the $C_{i,j}$ and ${p^c}_{i,j}$ are different from $\widehat{C}_{i,j}$ and $\widehat{p^c}_{i,j}$, as the their ground truths take 0/1 values:</p>
<table>
<tr>
<th></th>
<th>Estimate</th>
<th>Ground truth</th>
</tr>
<tr>
<th>$C_{i,j}$</th>
<td>between 0 and 1 </td>
<td>1 (=an object exists) or 0</td>
</tr>
<tr>
<td>$p^c_{i,j}$</td>
<td>between 0 and 1</td>
<td>1 (=$c$th class object exists) or 0
    </td>
</tr>
<tr>
<td></td>
<td></td>
<td>later transfered to class index  $c$</td>
</tr>
</table><p>When $C_{i,j}=1$, the scales of $x_{i,j}$, $y_{i,j}$, $w_{i,j}$, $h_{i,j}$ are the same as $\hat{x}_{i,j}$, $\hat{y}_{i,j}$, $\hat{w}_{i,j}$, $\hat{h}_{i,j}$.
When $C_{i,j}=0$, then all bounding box parameters $x_{i,j}$, $y_{i,j}$, $w_{i,j}$, $h_{i,j}$ takes zero values as no object exists for the (grid_cell, anchor) pair.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [50]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># y_batch is the output of the simpleBatchGenerator.fit()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Input y_batch = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

<span class="n">y_batch_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="p">(</span><span class="n">true_box_xy_tf</span><span class="p">,</span> <span class="n">true_box_wh_tf</span><span class="p">,</span> 
 <span class="n">true_box_conf_tf</span><span class="p">,</span> <span class="n">true_box_class_tf</span><span class="p">)</span> <span class="o">=</span> <span class="n">extract_ground_truth</span><span class="p">(</span><span class="n">y_batch_tf</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="p">(</span><span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span> 
         <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_class</span><span class="p">)</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">true_box_xy_tf</span><span class="p">,</span>   <span class="n">true_box_wh_tf</span><span class="p">,</span> 
                     <span class="n">true_box_conf_tf</span><span class="p">,</span> <span class="n">true_box_class_tf</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_xy </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>        
<span class="k">for</span> <span class="n">igrid_w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="n">vec</span>  <span class="o">=</span> <span class="n">true_box_xy</span><span class="p">[:,:,</span><span class="n">igrid_w</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">pick</span> <span class="o">=</span> <span class="n">true_box_conf</span><span class="p">[:,:,</span><span class="n">igrid_w</span><span class="p">,:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1">## only pick C_ij = 1</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">],</span><span class="s2">"  bounding box x at iGRID_W=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_w</span><span class="p">))</span>
    
<span class="k">for</span> <span class="n">igrid_h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">vec</span>  <span class="o">=</span> <span class="n">true_box_xy</span><span class="p">[:,</span><span class="n">igrid_h</span><span class="p">,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">pick</span> <span class="o">=</span> <span class="n">true_box_conf</span><span class="p">[:,</span><span class="n">igrid_h</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1">## only pick C_ij = 1</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">],</span><span class="s2">"  bounding box y at iGRID_H=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_h</span><span class="p">))</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_wh </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_wh</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">true_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box width "</span><span class="p">)</span> 
<span class="n">print_min_max</span><span class="p">(</span><span class="n">true_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box height"</span><span class="p">)</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_conf </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"  confidence, unique value = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">true_box_conf</span><span class="o">.</span><span class="n">flatten</span><span class="p">())))</span> 

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_class </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_class</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"  class index, unique value = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">true_box_class</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Input y_batch = (200, 13, 13, 4, 25)
******************************
ouput
******************************

true_box_xy (200, 13, 13, 4, 2)
  bounding box x at iGRID_W=00 MIN= 0.22, MAX= 0.97
  bounding box x at iGRID_W=01 MIN= 1.09, MAX= 1.73
  bounding box x at iGRID_W=02 MIN= 2.03, MAX= 2.95
  bounding box x at iGRID_W=03 MIN= 3.05, MAX= 3.94
  bounding box x at iGRID_W=04 MIN= 4.00, MAX= 4.98
  bounding box x at iGRID_W=05 MIN= 5.03, MAX= 5.98
  bounding box x at iGRID_W=06 MIN= 6.02, MAX= 6.97
  bounding box x at iGRID_W=07 MIN= 7.03, MAX= 7.95
  bounding box x at iGRID_W=08 MIN= 8.09, MAX= 8.98
  bounding box x at iGRID_W=09 MIN= 9.02, MAX= 9.95
  bounding box x at iGRID_W=10 MIN=10.03, MAX=10.92
  bounding box x at iGRID_W=11 MIN=11.06, MAX=11.95
  bounding box x at iGRID_W=12 MIN=12.08, MAX=12.88
  bounding box y at iGRID_H=00 MIN= 0.23, MAX= 0.59
  bounding box y at iGRID_H=01 MIN= 1.00, MAX= 1.48
  bounding box y at iGRID_H=02 MIN= 2.20, MAX= 2.59
  bounding box y at iGRID_H=03 MIN= 3.20, MAX= 3.98
  bounding box y at iGRID_H=04 MIN= 4.02, MAX= 4.98
  bounding box y at iGRID_H=05 MIN= 5.03, MAX= 5.98
  bounding box y at iGRID_H=06 MIN= 6.03, MAX= 6.98
  bounding box y at iGRID_H=07 MIN= 7.00, MAX= 7.98
  bounding box y at iGRID_H=08 MIN= 8.00, MAX= 8.98
  bounding box y at iGRID_H=09 MIN= 9.00, MAX= 9.97
  bounding box y at iGRID_H=10 MIN=10.05, MAX=10.91
  bounding box y at iGRID_H=11 MIN=11.05, MAX=11.95
  bounding box y at iGRID_H=12 MIN=12.27, MAX=12.73

true_box_wh (200, 13, 13, 4, 2)
  bounding box width  MIN= 0.00, MAX=13.00
  bounding box height MIN= 0.00, MAX=13.00

true_box_conf (200, 13, 13, 4)
  confidence, unique value = [0. 1.]

true_box_class (200, 13, 13, 4)
  class index, unique value = [ 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19]
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-3:-calculate-$\text{loss}_{i,j}^{xywh}$">Step 3: calculate $\text{loss}_{i,j}^{xywh}$<a class="anchor-link" href="#Step-3:-calculate-$\text{loss}_{i,j}^{xywh}$">¶</a></h3><p>Now we are ready to calculate the loss specific to the bounding box parameters.</p>
<p>\begin{array}{rl}
\textrm{loss}_{i,j}^{xywh}&=
\frac{1}{N_{L^{obj}}}
\lambda_{\textrm{coord}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\big[
\left(x_{i,j}-\hat{x}_{i,j}\right)^2 + 
\left(y_{i,j}-\hat{y}_{i,j}\right)^2 +\\
&\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\left(\sqrt{w}_{i,j}-\sqrt{\hat{w}}_{i,j}\right)^2 +
\left(\sqrt{h}_{i,j}-\sqrt{\hat{h}}_{i,j}\right)^2 
\big]
\end{array}</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [51]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_loss_xywh</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span>
                   <span class="n">COORD_SCALE</span><span class="p">,</span>
                   <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">pred_box_xy</span><span class="p">,</span><span class="n">true_box_wh</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">):</span>  
    <span class="sd">'''</span>
<span class="sd">    coord_mask:      np.array of shape (Nbatch, Ngrid h, N grid w, N anchor, 1)</span>
<span class="sd">                     lambda_{coord} L_{i,j}^{obj}     </span>
<span class="sd">                         </span>
<span class="sd">    '''</span>
    
    <span class="c1"># lambda_{coord} L_{i,j}^{obj} </span>
    <span class="c1"># np.array of shape (Nbatch, Ngrid h, N grid w, N anchor, 1)</span>
    <span class="n">coord_mask</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">COORD_SCALE</span> 
    <span class="n">nb_coord_box</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">coord_mask</span> <span class="o">></span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">loss_xy</span>      <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">-</span><span class="n">pred_box_xy</span><span class="p">)</span> <span class="o">*</span> <span class="n">coord_mask</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_coord_box</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">loss_wh</span>      <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">true_box_wh</span><span class="o">-</span><span class="n">pred_box_wh</span><span class="p">)</span> <span class="o">*</span> <span class="n">coord_mask</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_coord_box</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">return</span><span class="p">(</span><span class="n">loss_xy</span> <span class="o">+</span> <span class="n">loss_wh</span><span class="p">,</span> <span class="n">coord_mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_loss_xywh">Experiment <code>calc_loss_xywh</code><a class="anchor-link" href="#Experiment-calc_loss_xywh">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [52]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LAMBDA_COORD</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">loss_xywh_tf</span><span class="p">,</span> <span class="n">coord_mask_tf</span>  <span class="o">=</span> <span class="n">calc_loss_xywh</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">,</span><span class="n">LAMBDA_COORD</span><span class="p">,</span>
                                               <span class="n">true_box_xy_tf</span><span class="p">,</span> <span class="n">pred_box_xy_tf</span><span class="p">,</span><span class="n">true_box_wh_tf</span><span class="p">,</span><span class="n">pred_box_wh_tf</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">loss_xywh</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">loss_xywh_tf</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"loss_xywh = </span><span class="si">{:4.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss_xywh</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
ouput
******************************
loss_xywh = 3.035
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-4:-calculate-$\text{loss}_{i,j}^{p}$">Step 4: calculate $\text{loss}_{i,j}^{p}$<a class="anchor-link" href="#Step-4:-calculate-$\text{loss}_{i,j}^{p}$">¶</a></h3><p>$$
\textrm{loss}_{i,j}^p=-\frac{1}{N_{L^{obj}}}
\lambda_{\text{class}}\sum_{i=0}^{S^2} \sum_{j=0}^B L_{i,j}^{\text{obj}}
\sum_{c \in \text{class}}  p_{i,j}^c \text{log}(\hat{p}_{i,j}^c)
$$</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [53]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_loss_class</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span><span class="n">CLASS_SCALE</span><span class="p">,</span> <span class="n">true_box_class</span><span class="p">,</span><span class="n">pred_box_class</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    == input ==    </span>
<span class="sd">    true_box_conf  : tensor of shape (N batch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_class : tensor of shape (N batch, N grid h, N grid w, N anchor), containing class index</span>
<span class="sd">    pred_box_class : tensor of shape (N batch, N grid h, N grid w, N anchor, N class)</span>
<span class="sd">    CLASS_SCALE    : 1.0</span>
<span class="sd">    </span>
<span class="sd">    == output ==  </span>
<span class="sd">    class_mask</span>
<span class="sd">    if object exists in this (grid_cell, anchor) pair and the class object receive nonzero weight</span>
<span class="sd">        class_mask[iframe,igridy,igridx,ianchor] = 1 </span>
<span class="sd">    else: </span>
<span class="sd">        0 </span>
<span class="sd">    '''</span>   
    <span class="n">class_mask</span>   <span class="o">=</span> <span class="n">true_box_conf</span>  <span class="o">*</span> <span class="n">CLASS_SCALE</span> <span class="c1">## L_{i,j}^obj * lambda_class</span>
    
    <span class="n">nb_class_box</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">class_mask</span> <span class="o">></span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">loss_class</span>   <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">(</span><span class="n">labels</span> <span class="o">=</span> <span class="n">true_box_class</span><span class="p">,</span> 
                                                                  <span class="n">logits</span> <span class="o">=</span> <span class="n">pred_box_class</span><span class="p">)</span>
    <span class="n">loss_class</span>   <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">loss_class</span> <span class="o">*</span> <span class="n">class_mask</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_class_box</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>   
    <span class="k">return</span><span class="p">(</span><span class="n">loss_class</span><span class="p">)</span>


<span class="c1">#Example useage of tf.gather</span>
<span class="c1">#indices = np.array([[0,0],</span>
<span class="c1">#                    [1,0],</span>
<span class="c1">#                    [0,1]])</span>

<span class="c1">#arr  = tf.constant(indices)</span>
<span class="c1">#temp = tf.gather(np.array([100,-20]), arr)</span>
<span class="c1">#with tf.Session() as sess:</span>
<span class="c1">#    t = sess.run(temp)</span>
<span class="c1">#print(t)</span>

<span class="c1">#[[100 100]</span>
<span class="c1"># [-20 100]</span>
<span class="c1"># [100 -20]]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_loss_class">Experiment <code>calc_loss_class</code><a class="anchor-link" href="#Experiment-calc_loss_class">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [54]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LAMBDA_CLASS</span>   <span class="o">=</span> <span class="mi">1</span>
<span class="n">loss_class_tf</span>  <span class="o">=</span> <span class="n">calc_loss_class</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">,</span><span class="n">LAMBDA_CLASS</span><span class="p">,</span>
                                 <span class="n">true_box_class_tf</span><span class="p">,</span><span class="n">pred_box_class_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">loss_class</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss_class_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"loss_class = </span><span class="si">{:4.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss_class</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
ouput
******************************
loss_class = 2.994
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="$\textrm{loss}_{i,j}^c$">$\textrm{loss}_{i,j}^c$<a class="anchor-link" href="#$\textrm{loss}_{i,j}^c$">¶</a></h2><p>The rest of calculation is dedicated to evaluate confidence loss $\textrm{loss}_{i,j}^c$</p>
<p>$$
\textrm{loss}_{i,j}^c =\lambda_{\text{obj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\left(
IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} - \widehat{C}_{i,j}
\right)^2+
\lambda_{\textrm{noobj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{noobj}}
\left(0 - \widehat{C}_{i,j}\right)
$$</p>
<h3 id="Step-5,-calculate-$IOU_{\text{preduiction}_{i,j}}^{\text{ground-truth}_{i,j}}-$">Step 5, calculate $IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} $<a class="anchor-link" href="#Step-5,-calculate-$IOU_{\text{preduiction}_{i,j}}^{\text{ground-truth}_{i,j}}-$">¶</a></h3><p>For each (grid cell, anchor) pair, compute IOU between ground truth bounding box and predicted bounding box.
$IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} $ is 0 if $C_{i,j}=0$.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [55]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_intersect_area</span><span class="p">(</span><span class="n">true_xy</span><span class="p">,</span><span class="n">true_wh</span><span class="p">,</span>
                       <span class="n">pred_xy</span><span class="p">,</span><span class="n">pred_wh</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    == INPUT ==</span>
<span class="sd">    true_xy,pred_xy, true_wh and pred_wh must have the same shape length</span>

<span class="sd">    p1 : pred_mins = (px1,py1)</span>
<span class="sd">    p2 : pred_maxs = (px2,py2)</span>
<span class="sd">    t1 : true_mins = (tx1,ty1) </span>
<span class="sd">    t2 : true_maxs = (tx2,ty2) </span>
<span class="sd">                 p1______________________ </span>
<span class="sd">                 |      t1___________   |</span>
<span class="sd">                 |       |           |  |</span>
<span class="sd">                 |_______|___________|__|p2 </span>
<span class="sd">                         |           |rmax</span>
<span class="sd">                         |___________|</span>
<span class="sd">                                      t2</span>
<span class="sd">    intersect_mins : rmin = t1  = (tx1,ty1)</span>
<span class="sd">    intersect_maxs : rmax = (rmaxx,rmaxy)</span>
<span class="sd">    intersect_wh   : (rmaxx - tx1, rmaxy - ty1)</span>
<span class="sd">        </span>
<span class="sd">    '''</span>
    <span class="n">true_wh_half</span> <span class="o">=</span> <span class="n">true_wh</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">true_mins</span>    <span class="o">=</span> <span class="n">true_xy</span> <span class="o">-</span> <span class="n">true_wh_half</span>
    <span class="n">true_maxes</span>   <span class="o">=</span> <span class="n">true_xy</span> <span class="o">+</span> <span class="n">true_wh_half</span>
    
    <span class="n">pred_wh_half</span> <span class="o">=</span> <span class="n">pred_wh</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">pred_mins</span>    <span class="o">=</span> <span class="n">pred_xy</span> <span class="o">-</span> <span class="n">pred_wh_half</span>
    <span class="n">pred_maxes</span>   <span class="o">=</span> <span class="n">pred_xy</span> <span class="o">+</span> <span class="n">pred_wh_half</span>    
    
    <span class="n">intersect_mins</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">pred_mins</span><span class="p">,</span>  <span class="n">true_mins</span><span class="p">)</span>
    <span class="n">intersect_maxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">pred_maxes</span><span class="p">,</span> <span class="n">true_maxes</span><span class="p">)</span>
    <span class="n">intersect_wh</span>    <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">intersect_maxes</span> <span class="o">-</span> <span class="n">intersect_mins</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">intersect_areas</span> <span class="o">=</span> <span class="n">intersect_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">intersect_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="n">true_areas</span> <span class="o">=</span> <span class="n">true_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">true_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">pred_areas</span> <span class="o">=</span> <span class="n">pred_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pred_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">union_areas</span> <span class="o">=</span> <span class="n">pred_areas</span> <span class="o">+</span> <span class="n">true_areas</span> <span class="o">-</span> <span class="n">intersect_areas</span>
    <span class="n">iou_scores</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">truediv</span><span class="p">(</span><span class="n">intersect_areas</span><span class="p">,</span> <span class="n">union_areas</span><span class="p">)</span>    
    <span class="k">return</span><span class="p">(</span><span class="n">iou_scores</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calc_IOU_pred_true_assigned</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span>
                                <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span>
                                <span class="n">pred_box_xy</span><span class="p">,</span>  <span class="n">pred_box_wh</span><span class="p">):</span>
    <span class="sd">''' </span>
<span class="sd">    == input ==</span>
<span class="sd">    </span>
<span class="sd">    true_box_conf : tensor of shape (N batch, N grid h, N grid w, N anchor )</span>
<span class="sd">    true_box_xy   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">    true_box_wh   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">    pred_box_xy   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">    pred_box_wh   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">        </span>
<span class="sd">    == output ==</span>
<span class="sd">    </span>
<span class="sd">    true_box_conf : tensor of shape (N batch, N grid h, N grid w, N anchor)</span>
<span class="sd">    </span>
<span class="sd">    true_box_conf value depends on the predicted values </span>
<span class="sd">    true_box_conf = IOU_{true,pred} if objecte exist in this anchor else 0</span>
<span class="sd">    '''</span>
    <span class="n">iou_scores</span>        <span class="o">=</span>  <span class="n">get_intersect_area</span><span class="p">(</span><span class="n">true_box_xy</span><span class="p">,</span><span class="n">true_box_wh</span><span class="p">,</span>
                                            <span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">)</span>
    <span class="n">true_box_conf_IOU</span> <span class="o">=</span> <span class="n">iou_scores</span> <span class="o">*</span> <span class="n">true_box_conf</span>
    <span class="k">return</span><span class="p">(</span><span class="n">true_box_conf_IOU</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_IOU_pred_true_assigned">Experiment <code>calc_IOU_pred_true_assigned</code><a class="anchor-link" href="#Experiment-calc_IOU_pred_true_assigned">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [56]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">true_box_conf_IOU_tf</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_assigned</span><span class="p">(</span>
                            <span class="n">true_box_conf_tf</span><span class="p">,</span>
                            <span class="n">true_box_xy_tf</span><span class="p">,</span> <span class="n">true_box_wh_tf</span><span class="p">,</span>
                            <span class="n">pred_box_xy_tf</span><span class="p">,</span>  <span class="n">pred_box_wh_tf</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">true_box_conf_IOU</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">true_box_conf_IOU_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>    
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_tf = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_xy_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_xy_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_xy_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_IOU.shape = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_IOU</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">true_box_conf_IOU</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">pick</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!=</span><span class="mi">0</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Histogram</span><span class="se">\n</span><span class="s2">N (%) nonzero true_box_conf_IOU = </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:5.2f}</span><span class="s2">%)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pick</span><span class="p">),</span>
                                                             <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pick</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"nonzero true_box_conf_IOU"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
true_box_conf_tf = Tensor("strided_slice_110:0", shape=(200, 13, 13, 4), dtype=float32)
true_box_xy_tf   = Tensor("strided_slice_108:0", shape=(200, 13, 13, 4, 2), dtype=float32)
true_box_wh_tf   = Tensor("strided_slice_109:0", shape=(200, 13, 13, 4, 2), dtype=float32)
pred_box_xy_tf   = Tensor("add_62:0", shape=(200, 13, 13, 4, 2), dtype=float32)
pred_box_wh_tf   = Tensor("mul_74:0", shape=(200, 13, 13, 4, 2), dtype=float32)
******************************
ouput
******************************
true_box_conf_IOU.shape = (200, 13, 13, 4)
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt"></div>
<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
YII=
" />
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-6:-Calculate-$\text{max}_{i',j'}">Step 6: Calculate $\text{max}_{i',j'}<a class="anchor-link" href="#Step-6:-Calculate-$\text{max}_{i',j'}">¶</a></h3><p>\;\;IOU<em>{\text{preduiction}</em>{i,j}}^{\text{ground truth}_{i',j'}}$</p>
<p>For each predicted bounded box from (grid cell, anchor box), 
calculate the best IOU, regardless of the ground truth anchor box that each object gets assigned.</p>
<p>This calculation uses true_boxes tensor. 
This tensor corresponds to the input <code>b_batch</code> from SimpleBatchGenerator, which is already introduced in <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2</a>.</p>
<p>From the previous blog, I cite the <code>b_batch</code> description.</p>
<p><code>
b_batch
</code></p>
<p>The numpy array of shape <code>(BATCH_SIZE, 1, 1, 1, TRUE_BOX_BUFFER, 4)</code>.</p>
<ul>
<li><p><code>b_batch[iframe,1,1,1,ibuffer,:]</code> 
  contains <code>ibuffer</code>th object's <code>(center_x,center_y,center_w,center_h)</code> in <code>iframe</code>th frame.</p>
</li>
<li><p>If <code>ibuffer</code> > N objects in <code>iframe</code>th frame, then the values are simply 0.</p>
</li>
<li><p><code>TRUE_BOX_BUFFER</code> has to be some large number, so that the frame with the biggest number of objects can also record all objects.</p>
</li>
<li><p>The order of the objects do not matter.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [57]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_IOU_pred_true_best</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">,</span><span class="n">true_boxes</span><span class="p">):</span>   
    <span class="sd">'''</span>
<span class="sd">    == input ==</span>
<span class="sd">    pred_box_xy : tensor of shape (N batch, N grid h, N grid w, N anchor, 2)</span>
<span class="sd">    pred_box_wh : tensor of shape (N batch, N grid h, N grid w, N anchor, 2)</span>
<span class="sd">    true_boxes  : tensor of shape (N batch, N grid h, N grid w, N anchor, 2)</span>
<span class="sd">    </span>
<span class="sd">    == output == </span>
<span class="sd">    </span>
<span class="sd">    best_ious</span>
<span class="sd">    </span>
<span class="sd">    for each iframe,</span>
<span class="sd">        best_ious[iframe,igridy,igridx,ianchor] contains</span>
<span class="sd">        </span>
<span class="sd">        the IOU of the object that is most likely included (or best fitted) </span>
<span class="sd">        within the bounded box recorded in (grid_cell, anchor) pair</span>
<span class="sd">        </span>
<span class="sd">        NOTE: a same object may be contained in multiple (grid_cell, anchor) pair</span>
<span class="sd">              from best_ious, you cannot tell how may actual objects are captured as the "best" object</span>
<span class="sd">    '''</span>
    <span class="n">true_xy</span> <span class="o">=</span> <span class="n">true_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>           <span class="c1"># (N batch, 1, 1, 1, TRUE_BOX_BUFFER, 2)</span>
    <span class="n">true_wh</span> <span class="o">=</span> <span class="n">true_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>           <span class="c1"># (N batch, 1, 1, 1, TRUE_BOX_BUFFER, 2)</span>
    
    <span class="n">pred_xy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor, 1, 2)</span>
    <span class="n">pred_wh</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor, 1, 2)</span>
    
    <span class="n">iou_scores</span>  <span class="o">=</span>  <span class="n">get_intersect_area</span><span class="p">(</span><span class="n">true_xy</span><span class="p">,</span>
                                      <span class="n">true_wh</span><span class="p">,</span>
                                      <span class="n">pred_xy</span><span class="p">,</span>
                                      <span class="n">pred_wh</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor, 50)   </span>

    <span class="n">best_ious</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">iou_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">best_ious</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_IOU_pred_true_best">Experiment <code>calc_IOU_pred_true_best</code><a class="anchor-link" href="#Experiment-calc_IOU_pred_true_best">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [58]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">true_boxes_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">b_batch</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="n">best_ious_tf</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_best</span><span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">,</span>
                                       <span class="n">pred_box_wh_tf</span><span class="p">,</span>
                                       <span class="n">true_boxes_tf</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">best_ious</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">best_ious_tf</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>    
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_xy_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"best_ious.shape = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_ious</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">best_ious</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">pick</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!=</span><span class="mi">0</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Histogram</span><span class="se">\n</span><span class="s2">N (%) nonzero best_ious = </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:5.2f}</span><span class="s2">%)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pick</span><span class="p">),</span>
                                                             <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pick</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"nonzero best_ious"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
true_box_wh_tf   = Tensor("strided_slice_109:0", shape=(200, 13, 13, 4, 2), dtype=float32)
pred_box_xy_tf   = Tensor("add_62:0", shape=(200, 13, 13, 4, 2), dtype=float32)
pred_box_wh_tf   = Tensor("mul_74:0", shape=(200, 13, 13, 4, 2), dtype=float32)
******************************
ouput
******************************
best_ious.shape = (200, 13, 13, 4)
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt"></div>
<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
jlIbAAAAAElFTkSuQmCC
" />
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-7:-Calculate-$\lambda_{\text{noobj}}L_{i,j}^{\text{noobj}}$-and-$\lambda_{\text{obj}}L_{i,j}^{\text{obj}}$">Step 7: Calculate $\lambda_{\text{noobj}}L_{i,j}^{\text{noobj}}$ and $\lambda_{\text{obj}}L_{i,j}^{\text{obj}}$<a class="anchor-link" href="#Step-7:-Calculate-$\lambda_{\text{noobj}}L_{i,j}^{\text{noobj}}$-and-$\lambda_{\text{obj}}L_{i,j}^{\text{obj}}$">¶</a></h3><p>For each grid cell, calculate no object mask. 
$$
\begin{array}{rl}
L_{i,j}^{\text{noobj}}
& = 
\begin{cases}
 1 \;\;\text{if}\;\;\text{max}_{i',j'}
 \;\;IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i',j'}} < 0.6 \;\text{and}\; C_{i,j} = 0\\
 0\;\;\text{else}\\
\end{cases}
\end{array}
$$</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [59]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_conf_mask</span><span class="p">(</span><span class="n">best_ious</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_conf_IOU</span><span class="p">,</span><span class="n">LAMBDA_NO_OBJECT</span><span class="p">,</span> <span class="n">LAMBDA_OBJECT</span><span class="p">):</span>    
    <span class="sd">'''</span>
<span class="sd">    == input == </span>
<span class="sd">    </span>
<span class="sd">    best_ious           : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_conf       : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_conf_IOU   : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    LAMBDA_NO_OBJECT    : 1.0</span>
<span class="sd">    LAMBDA_OBJECT       : 5.0</span>
<span class="sd">    </span>
<span class="sd">    == output ==</span>
<span class="sd">    conf_mask : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    </span>
<span class="sd">    conf_mask[iframe, igridy, igridx, ianchor] = 0</span>
<span class="sd">               when there is no object assigned in (grid cell, anchor) pair and the region seems useless i.e. </span>
<span class="sd">               y_true[iframe,igridx,igridy,4] = 0 "and" the predicted region has no object that has IoU > 0.6</span>
<span class="sd">               </span>
<span class="sd">    conf_mask[iframe, igridy, igridx, ianchor] =  NO_OBJECT_SCALE</span>
<span class="sd">               when there is no object assigned in (grid cell, anchor) pair but region seems to include some object</span>
<span class="sd">               y_true[iframe,igridx,igridy,4] = 0 "and" the predicted region has some object that has IoU > 0.6</span>
<span class="sd">               </span>
<span class="sd">    conf_mask[iframe, igridy, igridx, ianchor] =  OBJECT_SCALE</span>
<span class="sd">              when there is an object in (grid cell, anchor) pair        </span>
<span class="sd">    '''</span>

    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">best_ious</span> <span class="o"><</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">true_box_conf</span><span class="p">)</span> <span class="o">*</span> <span class="n">LAMBDA_NO_OBJECT</span>
    <span class="c1"># penalize the confidence of the boxes, which are reponsible for corresponding ground truth box</span>
    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">conf_mask</span> <span class="o">+</span> <span class="n">true_box_conf_IOU</span> <span class="o">*</span> <span class="n">LAMBDA_OBJECT</span>
    <span class="k">return</span><span class="p">(</span><span class="n">conf_mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-get_conf_mask">Experiment <code>get_conf_mask</code><a class="anchor-link" href="#Experiment-get_conf_mask">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [60]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">conf_mask_tf</span> <span class="o">=</span> <span class="n">get_conf_mask</span><span class="p">(</span><span class="n">best_ious_tf</span><span class="p">,</span> 
                             <span class="n">true_box_conf_tf</span><span class="p">,</span> 
                             <span class="n">true_box_conf_IOU_tf</span><span class="p">,</span>
                             <span class="n">LAMBDA_NO_OBJECT</span><span class="p">,</span> 
                             <span class="n">LAMBDA_OBJECT</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>  
<span class="nb">print</span><span class="p">(</span><span class="s2">"best_ious         = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_ious_tf</span><span class="p">))</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf     = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_IOU = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_IOU_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"LAMBDA_NO_OBJECT  = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LAMBDA_NO_OBJECT</span><span class="p">))</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"LAMBDA_OBJECT     = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LAMBDA_OBJECT</span><span class="p">))</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conf_mask_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">output</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>      
<span class="nb">print</span><span class="p">(</span><span class="s2">"conf_mask shape = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conf_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
best_ious         = Tensor("Max_2:0", shape=(200, 13, 13, 4), dtype=float32)
true_box_conf     = Tensor("strided_slice_110:0", shape=(200, 13, 13, 4), dtype=float32)
true_box_conf_IOU = Tensor("mul_83:0", shape=(200, 13, 13, 4), dtype=float32)
LAMBDA_NO_OBJECT  = 1.0
LAMBDA_OBJECT     = 5.0
******************************
output
******************************
conf_mask shape = (200, 13, 13, 4)
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-8:-Calculate-loss-for-the-confidence-$\textrm{loss}_{i,j}^c$">Step 8: Calculate loss for the confidence $\textrm{loss}_{i,j}^c$<a class="anchor-link" href="#Step-8:-Calculate-loss-for-the-confidence-$\textrm{loss}_{i,j}^c$">¶</a></h3><p>$$
\textrm{loss}_{i,j}^c =
\frac{1}{N^{conf}}\left[
\lambda_{\text{obj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\left(
IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} - \widehat{C}_{i,j}
\right)^2+
\lambda_{\textrm{noobj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{noobj}}
\left(0 - \widehat{C}_{i,j}\right)
\right]
$$</p>
<ul>
<li>$N^{conf} =  \sum_{i=0}^{S^2}
\sum_{j=0}^B L_{i,j}^{\text{obj}} + L_{i,j}^{\text{noobj}}(1-L_{i,j}^{\text{obj}})$</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [61]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_loss_conf</span><span class="p">(</span><span class="n">conf_mask</span><span class="p">,</span><span class="n">true_box_conf_IOU</span><span class="p">,</span> <span class="n">pred_box_conf</span><span class="p">):</span>  
    <span class="sd">'''</span>
<span class="sd">    == input ==</span>
<span class="sd">    </span>
<span class="sd">    conf_mask         : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_conf_IOU : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    pred_box_conf     : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    '''</span>
    <span class="c1"># the number of (grid cell, anchor) pair that has an assigned object or</span>
    <span class="c1"># that has no assigned object but some objects may be in bounding box.</span>
    <span class="c1"># N conf</span>
    <span class="n">nb_conf_box</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">conf_mask</span>  <span class="o">></span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">loss_conf</span>    <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">true_box_conf_IOU</span><span class="o">-</span><span class="n">pred_box_conf</span><span class="p">)</span> <span class="o">*</span> <span class="n">conf_mask</span><span class="p">)</span>  <span class="o">/</span> <span class="p">(</span><span class="n">nb_conf_box</span>  <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">return</span><span class="p">(</span><span class="n">loss_conf</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Experiment-calc_loss_conf">Experiment <code>calc_loss_conf</code><a class="anchor-link" href="#Experiment-calc_loss_conf">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [62]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>  
<span class="nb">print</span><span class="p">(</span><span class="s2">"conf_mask_tf         = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conf_mask_tf</span><span class="p">))</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_IOU_tf = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_IOU_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_conf_tf     = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_conf_tf</span><span class="p">))</span>

<span class="n">loss_conf_tf</span> <span class="o">=</span> <span class="n">calc_loss_conf</span><span class="p">(</span><span class="n">conf_mask_tf</span><span class="p">,</span><span class="n">true_box_conf_IOU_tf</span><span class="p">,</span> <span class="n">pred_box_conf_tf</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">loss_conf</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss_conf_tf</span><span class="p">)</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">output</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>      
<span class="nb">print</span><span class="p">(</span><span class="s2">"loss_conf = </span><span class="si">{:5.4f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss_conf</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
conf_mask_tf         = Tensor("add_73:0", shape=(200, 13, 13, 4), dtype=float32)
true_box_conf_IOU_tf = Tensor("mul_83:0", shape=(200, 13, 13, 4), dtype=float32)
pred_box_conf_tf     = Tensor("Sigmoid_13:0", shape=(200, 13, 13, 4), dtype=float32)
******************************
output
******************************
loss_conf = 0.1249
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="custom_loss(y_true,y_pred)"><code>custom_loss(y_true,y_pred)</code><a class="anchor-link" href="#custom_loss(y_true,y_pred)">¶</a></h1><p>Finally combine all the calculation above into <code>custom_loss(y_true,y_pred)</code>
Notice that true_boxes are tensor defined when the Keras model is declared. 
However, this tensor will not be passed as explicit arguments of the loss function.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [63]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">custom_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    y_true : (N batch, N grid h, N grid w, N anchor, 4 + 1 + N classes)</span>
<span class="sd">    y_true[irow, i_gridh, i_gridw, i_anchor, :4] = center_x, center_y, w, h</span>
<span class="sd">    </span>
<span class="sd">        center_x : The x coordinate center of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  w (e.g., ranging between [0,13)</span>
<span class="sd">        center_y : The y coordinate center of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  h (e.g., ranging between [0,13)</span>
<span class="sd">        w        : The width of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  w (e.g., ranging between [0,13)</span>
<span class="sd">        h        : The height of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  h (e.g., ranging between [0,13)</span>
<span class="sd">                   </span>
<span class="sd">    y_true[irow, i_gridh, i_gridw, i_anchor, 4] = ground truth confidence</span>
<span class="sd">        </span>
<span class="sd">        ground truth confidence is 1 if object exists in this (anchor box, gird cell) pair</span>
<span class="sd">    </span>
<span class="sd">    y_true[irow, i_gridh, i_gridw, i_anchor, 5 + iclass] = 1 if the object is in category <iclass> else 0</span>
<span class="sd">        </span>
<span class="sd">    '''</span>
    <span class="n">total_recall</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
    
    <span class="c1"># Step 1: Adjust prediction output</span>
    <span class="n">cell_grid</span>   <span class="o">=</span> <span class="n">get_cell_grid</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">BOX</span><span class="p">)</span>
    <span class="n">pred_box_xy</span><span class="p">,</span> <span class="n">pred_box_wh</span><span class="p">,</span> <span class="n">pred_box_conf</span><span class="p">,</span> <span class="n">pred_box_class</span> <span class="o">=</span> <span class="n">adjust_scale_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">cell_grid</span><span class="p">,</span><span class="n">ANCHORS</span><span class="p">)</span>
    <span class="c1"># Step 2: Extract ground truth output</span>
    <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_class</span> <span class="o">=</span> <span class="n">extract_ground_truth</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="c1"># Step 3: Calculate loss for the bounding box parameters</span>
    <span class="n">loss_xywh</span><span class="p">,</span> <span class="n">coord_mask</span> <span class="o">=</span> <span class="n">calc_loss_xywh</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span><span class="n">LAMBDA_COORD</span><span class="p">,</span>
                                           <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">pred_box_xy</span><span class="p">,</span><span class="n">true_box_wh</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">)</span>
    <span class="c1"># Step 4: Calculate loss for the class probabilities</span>
    <span class="n">loss_class</span>  <span class="o">=</span> <span class="n">calc_loss_class</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span><span class="n">LAMBDA_CLASS</span><span class="p">,</span>
                                   <span class="n">true_box_class</span><span class="p">,</span><span class="n">pred_box_class</span><span class="p">)</span>
    <span class="c1"># Step 5: For each (grid cell, anchor) pair, </span>
    <span class="c1">#         calculate the IoU between predicted and ground truth bounding box</span>
    <span class="n">true_box_conf_IOU</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_assigned</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span>
                                                    <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span>
                                                    <span class="n">pred_box_xy</span><span class="p">,</span> <span class="n">pred_box_wh</span><span class="p">)</span>
    <span class="c1"># Step 6: For each predicted bounded box from (grid cell, anchor box), </span>
    <span class="c1">#         calculate the best IOU, regardless of the ground truth anchor box that each object gets assigned.</span>
    <span class="n">best_ious</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_best</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">,</span><span class="n">true_boxes</span><span class="p">)</span>
    <span class="c1"># Step 7: For each grid cell, calculate the L_{i,j}^{noobj}</span>
    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">get_conf_mask</span><span class="p">(</span><span class="n">best_ious</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_conf_IOU</span><span class="p">,</span><span class="n">LAMBDA_NO_OBJECT</span><span class="p">,</span> <span class="n">LAMBDA_OBJECT</span><span class="p">)</span>
    <span class="c1"># Step 8: Calculate loss for the confidence</span>
    <span class="n">loss_conf</span> <span class="o">=</span> <span class="n">calc_loss_conf</span><span class="p">(</span><span class="n">conf_mask</span><span class="p">,</span><span class="n">true_box_conf_IOU</span><span class="p">,</span> <span class="n">pred_box_conf</span><span class="p">)</span>

    
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_xywh</span> <span class="o">+</span> <span class="n">loss_conf</span> <span class="o">+</span> <span class="n">loss_class</span>
    

    
    <span class="k">return</span> <span class="n">loss</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Experiment-custom_loss">Experiment <code>custom_loss</code><a class="anchor-link" href="#Experiment-custom_loss">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [64]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">true_boxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">b_batch</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="n">loss_tf</span>    <span class="o">=</span> <span class="n">custom_loss</span><span class="p">(</span><span class="n">y_batch_tf</span><span class="p">,</span> <span class="n">y_pred_tf</span><span class="p">)</span> 
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss_tf</span><span class="p">,</span>
                    <span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">true_boxes</span><span class="p">:</span> <span class="n">b_batch</span><span class="p">})</span>
<span class="n">loss</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[64]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>6.1540704</pre>
</div>
</div>
</div>
</div>
</div>

<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['$','$'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        " linebreaks: { automatic: true, width: '95% container' }, " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
</div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Yumi</span>
  </span>
<time datetime="2018-12-09T20:00:00-08:00" pubdate>Sun 09 December 2018</time>  <span class="categories">
    <a class="category" href="https://FairyOnIce.github.io/tag/computer-vision.html">Computer Vision</a>
    <a class="category" href="https://FairyOnIce.github.io/tag/pascal-voc2012.html">PASCAL VOC2012</a>
    <a class="category" href="https://FairyOnIce.github.io/tag/object-detection.html">Object Detection</a>
    <a class="category" href="https://FairyOnIce.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection using YOLOv2 on Pascal VOC2012 series</a>
  </span>
</p><div class="sharing">
  <a href="https://twitter.com/share" class="twitter-share-button" data-url="https://FairyOnIce.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html" data-via="" data-counturl="https://FairyOnIce.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html" >Tweet</a>
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
</div>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://yumis-blog.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
     
    </section>
</div>
<aside class="sidebar">

<section>
    <h1>Local Search</h1></hr>
    <form class="navbar-search" action="https://FairyOnIce.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="" name="q" id="tipue_search_input"><input type="submit" value="Go!"></form></li>
</section>
    
<section>

    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="https://FairyOnIce.github.io/Part_7_Object_Detection_with_Yolo_using_VOC_2012_data_inference_video.html">Part 7 Object Detection with Yolo using VOC 2012 data - inference on video</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/Part_6_Object_Detection_with_Yolo_using_VOC_2012_data_inference_image.html">Part 6 Object Detection with Yolo using VOC 2012 data - inference on image</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/Part_5_Object_Detection_with_Yolo_using_VOC_2012_data_training.html">Part 5 Object Detection using YOLOv2 on Pascal VOC2012 - training</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html">Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/Part_3_Object_Detection_with_Yolo_using_VOC_2012_data_model.html">Part 3 Object Detection using YOLOv2 on Pascal VOC2012 - model</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="https://FairyOnIce.github.io/category/blog.html">Blog</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="https://FairyOnIce.github.io/tag/bleu.html">BLEU</a>,    <a href="https://FairyOnIce.github.io/tag/spectrogram.html">Spectrogram</a>,    <a href="https://FairyOnIce.github.io/tag/computer-vision.html">Computer Vision</a>,    <a href="https://FairyOnIce.github.io/tag/nlp.html">NLP</a>,    <a href="https://FairyOnIce.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection using YOLOv2 on Pascal VOC2012 series</a>,    <a href="https://FairyOnIce.github.io/tag/api.html">API</a>,    <a href="https://FairyOnIce.github.io/tag/pascal-voc2012.html">PASCAL VOC2012</a>,    <a href="https://FairyOnIce.github.io/tag/object-detection-using-rcnn-on-pascal-voc2012-series.html">Object Detection using RCNN on Pascal VOC2012 series</a>,    <a href="https://FairyOnIce.github.io/tag/gps-watch.html">GPS watch</a>,    <a href="https://FairyOnIce.github.io/tag/deep-learning.html">deep learning</a>,    <a href="https://FairyOnIce.github.io/tag/heroku.html">Heroku</a>,    <a href="https://FairyOnIce.github.io/tag/object-detection.html">Object Detection</a>,    <a href="https://FairyOnIce.github.io/tag/game.html">Game</a>,    <a href="https://FairyOnIce.github.io/tag/tensorflow.html">TensorFlow</a>,    <a href="https://FairyOnIce.github.io/tag/celeba.html">CelebA</a>,    <a href="https://FairyOnIce.github.io/tag/statistics.html">Statistics</a>,    <a href="https://FairyOnIce.github.io/tag/model.html">Model</a>,    <a href="https://FairyOnIce.github.io/tag/natural-language-processing.html">Natural Language Processing</a>,    <a href="https://FairyOnIce.github.io/tag/fourier-transform.html">Fourier Transform</a>  </section>


    <section>
        <h1>Social</h1>
        <ul>
            <li><a href="https://www.linkedin.com/notifications/" target="_blank">LinkedIn</a></li>
            <li><a href="https://github.com/FairyOnIce" target="_blank">Github</a></li>
        </ul>
    </section>
    <section>
        <h1>Blogroll</h1>
        <ul>
            <li><a href="https://getpelican.com/" target="_blank">Pelican</a></li>
            <li><a href="https://python.org/" target="_blank">Python.org</a></li>
        </ul>
    </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Yumi -
  <span class="credit">Powered by <a href="https://getpelican.com">Pelican</a></span>
</p></footer>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-112020731-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-112020731-1');
    ga('send', 'pageview');
</script>
	<script type="text/javascript">
	  var disqus_shortname = 'yumis-blog';
          var disqus_identifier = '/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html';
          var disqus_url = 'https://FairyOnIce.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html';
          var disqus_title = 'Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
</body>
</html>