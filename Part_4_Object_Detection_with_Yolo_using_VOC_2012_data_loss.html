<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>


   <!-- Global site tag (gtag.js) - Google Analytics -->
   <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112020731-1"></script>
   <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());

   gtag('config', 'UA-112020731-1');
   </script>

 

  <meta charset="utf-8">
  <title>Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss</title>
  <meta name="author" content="Yumi">



  <!-- https://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://FairyOnIce.github.io/favicon.png" rel="icon">
  <link href="https://FairyOnIce.github.io/theme/css/main.css" media="screen, projection"
rel="stylesheet" type="text/css">
 <link rel="stylesheet" href="https://FairyOnIce.github.io/theme/tipuesearch.css">
  <script src="https://FairyOnIce.github.io/theme/js/modernizr-2.0.js"></script>
  <script src="https://FairyOnIce.github.io/theme/js/ender.js"></script>
  <script src="https://FairyOnIce.github.io/theme/js/octopress.js" type="text/javascript"></script>

  <link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="https://FairyOnIce.github.io/">Yumi's Blog</a></h1>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:FairyOnIce.github.io" />
    <input class="search" type="text" name="q" results="0"
placeholder="Google Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
    <li><a href="/archives.html">Archives</a></li>
      <li><a href="https://FairyOnIce.github.io/pages/deployment.html">Deployment</a></li>
      <li><a href="https://FairyOnIce.github.io/pages/quest.html">Quest</a></li>
    <li class="active">
    <a href="https://FairyOnIce.github.io/category/blog.html">Blog</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss</h1>
      <p class="meta"><time datetime="2018-12-09T20:00:00-08:00" pubdate>Sun 09 December 2018</time></p>
</header>

  <div class="entry-content"><style type="text/css">/*!
*
* IPython notebook
*
*/
/* CSS font colors for translated ANSI colors. */
.ansibold {
  font-weight: bold;
}
/* use dark versions for foreground, to improve visibility */
.ansiblack {
  color: black;
}
.ansired {
  color: darkred;
}
.ansigreen {
  color: darkgreen;
}
.ansiyellow {
  color: #c4a000;
}
.ansiblue {
  color: darkblue;
}
.ansipurple {
  color: darkviolet;
}
.ansicyan {
  color: steelblue;
}
.ansigray {
  color: gray;
}
/* and light for background, for the same reason */
.ansibgblack {
  background-color: black;
}
.ansibgred {
  background-color: red;
}
.ansibggreen {
  background-color: green;
}
.ansibgyellow {
  background-color: yellow;
}
.ansibgblue {
  background-color: blue;
}
.ansibgpurple {
  background-color: magenta;
}
.ansibgcyan {
  background-color: cyan;
}
.ansibggray {
  background-color: gray;
}
div.cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  border-radius: 2px;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  border-width: 1px;
  border-style: solid;
  border-color: transparent;
  width: 100%;
  padding: 5px;
  /* This acts as a spacer between cells, that is outside the border */
  margin: 0px;
  outline: none;
  border-left-width: 1px;
  padding-left: 5px;
  background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%);
}
div.cell.jupyter-soft-selected {
  border-left-color: #90CAF9;
  border-left-color: #E3F2FD;
  border-left-width: 1px;
  padding-left: 5px;
  border-right-color: #E3F2FD;
  border-right-width: 1px;
  background: #E3F2FD;
}
@media print {
  div.cell.jupyter-soft-selected {
    border-color: transparent;
  }
}
div.cell.selected {
  border-color: #ababab;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%);
}
@media print {
  div.cell.selected {
    border-color: transparent;
  }
}
div.cell.selected.jupyter-soft-selected {
  border-left-width: 0;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%);
}
.edit_mode div.cell.selected {
  border-color: #66BB6A;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%);
}
@media print {
  .edit_mode div.cell.selected {
    border-color: transparent;
  }
}
.prompt {
  /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */
  min-width: 14ex;
  /* This padding is tuned to match the padding on the CodeMirror editor. */
  padding: 0.4em;
  margin: 0px;
  font-family: monospace;
  text-align: right;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
  /* Don't highlight prompt number selection */
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  /* Use default cursor */
  cursor: default;
}
@media (max-width: 540px) {
  .prompt {
    text-align: left;
  }
}
div.inner_cell {
  min-width: 0;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_area {
  border: 1px solid #cfcfcf;
  border-radius: 2px;
  background: #f7f7f7;
  line-height: 1.21429em;
}
/* This is needed so that empty prompt areas can collapse to zero height when there
   is no content in the output_subarea and the prompt. The main purpose of this is
   to make sure that empty JavaScript output_subareas have no height. */
div.prompt:empty {
  padding-top: 0;
  padding-bottom: 0;
}
div.unrecognized_cell {
  padding: 5px 5px 5px 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.unrecognized_cell .inner_cell {
  border-radius: 2px;
  padding: 5px;
  font-weight: bold;
  color: red;
  border: 1px solid #cfcfcf;
  background: #eaeaea;
}
div.unrecognized_cell .inner_cell a {
  color: inherit;
  text-decoration: none;
}
div.unrecognized_cell .inner_cell a:hover {
  color: inherit;
  text-decoration: none;
}
@media (max-width: 540px) {
  div.unrecognized_cell > div.prompt {
    display: none;
  }
}
div.code_cell {
  /* avoid page breaking on code cells when printing */
}
@media print {
  div.code_cell {
    page-break-inside: avoid;
  }
}
/* any special styling for code cells that are currently running goes here */
div.input {
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.input {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_prompt {
  color: #303F9F;
  border-top: 1px solid transparent;
}
div.input_area > div.highlight {
  margin: 0.4em;
  border: none;
  padding: 0px;
  background-color: transparent;
}
div.input_area > div.highlight > pre {
  margin: 0px;
  border: none;
  padding: 0px;
  background-color: transparent;
}
/* The following gets added to the <head> if it is detected that the user has a
 * monospace font with inconsistent normal/bold/italic height.  See
 * notebookmain.js.  Such fonts will have keywords vertically offset with
 * respect to the rest of the text.  The user should select a better font.
 * See: https://github.com/ipython/ipython/issues/1503
 *
 * .CodeMirror span {
 *      vertical-align: bottom;
 * }
 */
.CodeMirror {
  line-height: 1.21429em;
  /* Changed from 1em to our global default */
  font-size: 14px;
  height: auto;
  /* Changed to auto to autogrow */
  background: none;
  /* Changed from white to allow our bg to show through */
}
.CodeMirror-scroll {
  /*  The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/
  /*  We have found that if it is visible, vertical scrollbars appear with font size changes.*/
  overflow-y: hidden;
  overflow-x: auto;
}
.CodeMirror-lines {
  /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */
  /* we have set a different line-height and want this to scale with that. */
  padding: 0.4em;
}
.CodeMirror-linenumber {
  padding: 0 8px 0 4px;
}
.CodeMirror-gutters {
  border-bottom-left-radius: 2px;
  border-top-left-radius: 2px;
}
.CodeMirror pre {
  /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */
  /* .CodeMirror-lines */
  padding: 0;
  border: 0;
  border-radius: 0;
}
/*

Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org>
Adapted from GitHub theme

*/
.highlight-base {
  color: #000;
}
.highlight-variable {
  color: #000;
}
.highlight-variable-2 {
  color: #1a1a1a;
}
.highlight-variable-3 {
  color: #333333;
}
.highlight-string {
  color: #BA2121;
}
.highlight-comment {
  color: #408080;
  font-style: italic;
}
.highlight-number {
  color: #080;
}
.highlight-atom {
  color: #88F;
}
.highlight-keyword {
  color: #008000;
  font-weight: bold;
}
.highlight-builtin {
  color: #008000;
}
.highlight-error {
  color: #f00;
}
.highlight-operator {
  color: #AA22FF;
  font-weight: bold;
}
.highlight-meta {
  color: #AA22FF;
}
/* previously not defined, copying from default codemirror */
.highlight-def {
  color: #00f;
}
.highlight-string-2 {
  color: #f50;
}
.highlight-qualifier {
  color: #555;
}
.highlight-bracket {
  color: #997;
}
.highlight-tag {
  color: #170;
}
.highlight-attribute {
  color: #00c;
}
.highlight-header {
  color: blue;
}
.highlight-quote {
  color: #090;
}
.highlight-link {
  color: #00c;
}
/* apply the same style to codemirror */
.cm-s-ipython span.cm-keyword {
  color: #008000;
  font-weight: bold;
}
.cm-s-ipython span.cm-atom {
  color: #88F;
}
.cm-s-ipython span.cm-number {
  color: #080;
}
.cm-s-ipython span.cm-def {
  color: #00f;
}
.cm-s-ipython span.cm-variable {
  color: #000;
}
.cm-s-ipython span.cm-operator {
  color: #AA22FF;
  font-weight: bold;
}
.cm-s-ipython span.cm-variable-2 {
  color: #1a1a1a;
}
.cm-s-ipython span.cm-variable-3 {
  color: #333333;
}
.cm-s-ipython span.cm-comment {
  color: #408080;
  font-style: italic;
}
.cm-s-ipython span.cm-string {
  color: #BA2121;
}
.cm-s-ipython span.cm-string-2 {
  color: #f50;
}
.cm-s-ipython span.cm-meta {
  color: #AA22FF;
}
.cm-s-ipython span.cm-qualifier {
  color: #555;
}
.cm-s-ipython span.cm-builtin {
  color: #008000;
}
.cm-s-ipython span.cm-bracket {
  color: #997;
}
.cm-s-ipython span.cm-tag {
  color: #170;
}
.cm-s-ipython span.cm-attribute {
  color: #00c;
}
.cm-s-ipython span.cm-header {
  color: blue;
}
.cm-s-ipython span.cm-quote {
  color: #090;
}
.cm-s-ipython span.cm-link {
  color: #00c;
}
.cm-s-ipython span.cm-error {
  color: #f00;
}
.cm-s-ipython span.cm-tab {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=);
  background-position: right;
  background-repeat: no-repeat;
}
div.output_wrapper {
  /* this position must be relative to enable descendents to be absolute within it */
  position: relative;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  z-index: 1;
}
/* class for the output area when it should be height-limited */
div.output_scroll {
  /* ideally, this would be max-height, but FF barfs all over that */
  height: 24em;
  /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */
  width: 100%;
  overflow: auto;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  display: block;
}
/* output div while it is collapsed */
div.output_collapsed {
  margin: 0px;
  padding: 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
div.out_prompt_overlay {
  height: 100%;
  padding: 0px 0.4em;
  position: absolute;
  border-radius: 2px;
}
div.out_prompt_overlay:hover {
  /* use inner shadow to get border that is computed the same on WebKit/FF */
  -webkit-box-shadow: inset 0 0 1px #000;
  box-shadow: inset 0 0 1px #000;
  background: rgba(240, 240, 240, 0.5);
}
div.output_prompt {
  color: #D84315;
}
/* This class is the outer container of all output sections. */
div.output_area {
  padding: 0px;
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.output_area .MathJax_Display {
  text-align: left !important;
}
div.output_area 
div.output_area 
div.output_area img,
div.output_area svg {
  max-width: 100%;
  height: auto;
}
div.output_area img.unconfined,
div.output_area svg.unconfined {
  max-width: none;
}
/* This is needed to protect the pre formating from global settings such
   as that of bootstrap */
.output {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.output_area {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
div.output_area pre {
  margin: 0;
  padding: 0;
  border: 0;
  vertical-align: baseline;
  color: black;
  background-color: transparent;
  border-radius: 0;
}
/* This class is for the output subarea inside the output_area and after
   the prompt div. */
div.output_subarea {
  overflow-x: auto;
  padding: 0.4em;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
  max-width: calc(100% - 14ex);
}
div.output_scroll div.output_subarea {
  overflow-x: visible;
}
/* The rest of the output_* classes are for special styling of the different
   output types */
/* all text output has this class: */
div.output_text {
  text-align: left;
  color: #000;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
}
/* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */
div.output_stderr {
  background: #fdd;
  /* very light red background for stderr */
}
div.output_latex {
  text-align: left;
}
/* Empty output_javascript divs should have no height */
div.output_javascript:empty {
  padding: 0;
}
.js-error {
  color: darkred;
}
/* raw_input styles */
div.raw_input_container {
  line-height: 1.21429em;
  padding-top: 5px;
}
pre.raw_input_prompt {
  /* nothing needed here. */
}
input.raw_input {
  font-family: monospace;
  font-size: inherit;
  color: inherit;
  width: auto;
  /* make sure input baseline aligns with prompt */
  vertical-align: baseline;
  /* padding + margin = 0.5em between prompt and cursor */
  padding: 0em 0.25em;
  margin: 0em 0.25em;
}
input.raw_input:focus {
  box-shadow: none;
}
p.p-space {
  margin-bottom: 10px;
}
div.output_unrecognized {
  padding: 5px;
  font-weight: bold;
  color: red;
}
div.output_unrecognized a {
  color: inherit;
  text-decoration: none;
}
div.output_unrecognized a:hover {
  color: inherit;
  text-decoration: none;
}
.rendered_html {
  color: #000;
  /* any extras will just be numbers: */
}



.rendered_html :link {
  text-decoration: underline;
}
.rendered_html :visited {
  text-decoration: underline;
}






.rendered_html h1:first-child {
  margin-top: 0.538em;
}
.rendered_html h2:first-child {
  margin-top: 0.636em;
}
.rendered_html h3:first-child {
  margin-top: 0.777em;
}
.rendered_html h4:first-child {
  margin-top: 1em;
}
.rendered_html h5:first-child {
  margin-top: 1em;
}
.rendered_html h6:first-child {
  margin-top: 1em;
}








.rendered_html * + ul {
  margin-top: 1em;
}
.rendered_html * + ol {
  margin-top: 1em;
}


.rendered_html pre,



.rendered_html tr,
.rendered_html th,

.rendered_html td,


.rendered_html * + table {
  margin-top: 1em;
}

.rendered_html * + p {
  margin-top: 1em;
}

.rendered_html * + img {
  margin-top: 1em;
}
.rendered_html img,

.rendered_html img.unconfined,

div.text_cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.text_cell > div.prompt {
    display: none;
  }
}
div.text_cell_render {
  /*font-family: "Helvetica Neue", Arial, Helvetica, Geneva, sans-serif;*/
  outline: none;
  resize: none;
  width: inherit;
  border-style: none;
  padding: 0.5em 0.5em 0.5em 0.4em;
  color: #000;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
}
a.anchor-link:link {
  text-decoration: none;
  padding: 0px 20px;
  visibility: hidden;
}
h1:hover .anchor-link,
h2:hover .anchor-link,
h3:hover .anchor-link,
h4:hover .anchor-link,
h5:hover .anchor-link,
h6:hover .anchor-link {
  visibility: visible;
}
.text_cell.rendered .input_area {
  display: none;
}
.text_cell.rendered 
.text_cell.unrendered .text_cell_render {
  display: none;
}
.cm-header-1,
.cm-header-2,
.cm-header-3,
.cm-header-4,
.cm-header-5,
.cm-header-6 {
  font-weight: bold;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}
.cm-header-1 {
  font-size: 185.7%;
}
.cm-header-2 {
  font-size: 157.1%;
}
.cm-header-3 {
  font-size: 128.6%;
}
.cm-header-4 {
  font-size: 110%;
}
.cm-header-5 {
  font-size: 100%;
  font-style: italic;
}
.cm-header-6 {
  font-size: 100%;
  font-style: italic;
}
</style>
<style type="text/css">.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>
<style type="text/css">
/* Temporary definitions which will become obsolete with Notebook release 5.0 */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="experiencor/keras-yolo2's-YOLO-V2-loss"><a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss<a class="anchor-link" href="#experiencor/keras-yolo2's-YOLO-V2-loss">¶</a></h3><p><img alt="YOLO v2 loss funciton" height="570" src="https://farm8.staticflickr.com/7904/45592720625_821897e898_b.jpg" width="1024" /></a></p>
<p>This is the fourth blog post of <a href="https://fairyonice.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection with YOLO blog series</a>. 
This blog discusses the YOLO's loss funciton. This will be the most intense blog post in <a href="https://fairyonice.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection with YOLO blog series</a>. as loss function of YOLO is quite complex. So please get excited! 
For demonstration of the code, I will agian use PASCAL VOC2012 data. 
This blog assumes that the readers have read the previous two blog posts - <a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1</a>, <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2</a> and <a href="https://fairyonice.github.io/Part_3_Object_Detection_with_Yolo_using_VOC_2012_data_model.html">Part 3</a>.</p>
<h2 id="Andrew-Ng's-YOLO-lecture">Andrew Ng's YOLO lecture<a class="anchor-link" href="#Andrew-Ng's-YOLO-lecture">¶</a></h2><ul>
<li><a href="https://www.youtube.com/watch?v=gKreZOUi-O0&amp;t=0s&amp;index=7&amp;list=PL_IHmaMAvkVxdDOBRg2CbcJBq9SY7ZUvs">Neural Networks - Bounding Box Predictions</a></li>
<li><a href="https://www.youtube.com/watch?v=ANIzQ5G-XPE&amp;t=7s">C4W3L06 Intersection Over Union</a></li>
<li><a href="https://www.youtube.com/watch?v=VAo84c1hQX8&amp;t=192s">C4W3L07 Nonmax Suppression</a></li>
<li><a href="https://www.youtube.com/watch?v=RTlwl2bv0Tg&amp;t=28s">C4W3L08 Anchor Boxes</a></li>
<li><a href="https://www.youtube.com/watch?v=9s_FpMpdYW8&amp;t=34s">C4W3L09 YOLO Algorithm</a></li>
</ul>
<h2 id="Reference">Reference<a class="anchor-link" href="#Reference">¶</a></h2><ul>
<li><p><a href="https://arxiv.org/pdf/1506.02640.pdf">You Only Look Once:Unified, Real-Time Object Detection</a></p>
</li>
<li><p><a href="https://arxiv.org/pdf/1612.08242.pdf">YOLO9000:Better, Faster, Stronger</a></p>
</li>
<li><p><a href="https://github.com/experiencor/keras-yolo2">experiencor/keras-yolo2</a></p>
</li>
</ul>
<h2 id="Reference-in-my-blog">Reference in my blog<a class="anchor-link" href="#Reference-in-my-blog">¶</a></h2><ul>
<li><a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1 Object Detection using YOLOv2 on Pascal VOC2012 - anchor box clustering</a></li>
<li><a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a></li>
<li><a href="https://fairyonice.github.io/Part_3_Object_Detection_with_Yolo_using_VOC_2012_data_model.html">Part 3 Object Detection using YOLOv2 on Pascal VOC2012 - model</a></li>
<li><a href="https://fairyonice.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html">Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss</a></li>
<li><a href="https://fairyonice.github.io/Part_5_Object_Detection_with_Yolo_using_VOC_2012_data_training.html">Part 5 Object Detection using YOLOv2 on Pascal VOC2012 - training</a></li>
<li><a href="https://fairyonice.github.io/Part_6_Object_Detection_with_Yolo_using_VOC_2012_data_inference_image.html">Part 6 Object Detection using YOLOv2 on Pascal VOC 2012 data - inference on image</a></li>
<li><a href="https://fairyonice.github.io/Part_6_Object_Detection_with_Yolo_using_VOC_2012_data_inference_video.html">Part 7 Object Detection using YOLOv2 on Pascal VOC 2012 data - inference on video</a></li>
</ul>
<h2 id="My-GitHub-repository">My GitHub repository<a class="anchor-link" href="#My-GitHub-repository">¶</a></h2><p>This repository contains all the ipython notebooks in this blog series and the funcitons (See backend.py).</p>
<ul>
<li><a href="https://github.com/FairyOnIce/ObjectDetectionYolo">FairyOnIce/ObjectDetectionYolo</a></li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/yumikondo/anaconda3/lib/python3.6/site-packages/h5py/__init__.py:34: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.
  from ._conv import register_converters as _register_converters
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>3.6.3 |Anaconda, Inc.| (default, Oct  6 2017, 12:04:38) 
[GCC 4.2.1 Compatible Clang 4.0.1 (tags/RELEASE_401/final)]
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Define-anchor-box">Define anchor box<a class="anchor-link" href="#Define-anchor-box">¶</a></h2><p><code>ANCHORS</code> defines the number of anchor boxes and the shape of each anchor box.
The choice of the anchor box specialization is already discussed in <a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1 Object Detection using YOLOv2 on Pascal VOC2012 - anchor box clustering</a>.</p>
<p>Based on the K-means analysis in the previous blog post, I will select 4 anchor boxes of following width and height. The width and heights are rescaled in the grid cell scale (Assuming that the number of grid size is 13 by 13.) See <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a> to learn how I rescal the anchor box shapes into the grid cell scale.</p>
<p>Here I choose 4 anchor boxes. With 13 by 13 grids, every frame gets 4 x 13 x 13 = 676 bouding box predictions.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ANCHORS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.07709888</span><span class="p">,</span>  <span class="mf">1.78171903</span><span class="p">,</span>  <span class="c1"># anchor box 1, width , height</span>
                    <span class="mf">2.71054693</span><span class="p">,</span>  <span class="mf">5.12469308</span><span class="p">,</span>  <span class="c1"># anchor box 2, width,  height</span>
                   <span class="mf">10.47181473</span><span class="p">,</span> <span class="mf">10.09646365</span><span class="p">,</span>  <span class="c1"># anchor box 3, width,  height</span>
                    <span class="mf">5.48531347</span><span class="p">,</span>  <span class="mf">8.11011331</span><span class="p">])</span> <span class="c1"># anchor box 4, width,  height</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Define-Label-vector-containing-20-object-classe-names.">Define Label vector containing 20 object classe names.<a class="anchor-link" href="#Define-Label-vector-containing-20-object-classe-names.">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LABELS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'aeroplane'</span><span class="p">,</span>  <span class="s1">'bicycle'</span><span class="p">,</span> <span class="s1">'bird'</span><span class="p">,</span>  <span class="s1">'boat'</span><span class="p">,</span>      <span class="s1">'bottle'</span><span class="p">,</span> 
          <span class="s1">'bus'</span><span class="p">,</span>        <span class="s1">'car'</span><span class="p">,</span>      <span class="s1">'cat'</span><span class="p">,</span>  <span class="s1">'chair'</span><span class="p">,</span>     <span class="s1">'cow'</span><span class="p">,</span>
          <span class="s1">'diningtable'</span><span class="p">,</span><span class="s1">'dog'</span><span class="p">,</span>    <span class="s1">'horse'</span><span class="p">,</span>  <span class="s1">'motorbike'</span><span class="p">,</span> <span class="s1">'person'</span><span class="p">,</span>
          <span class="s1">'pottedplant'</span><span class="p">,</span><span class="s1">'sheep'</span><span class="p">,</span>  <span class="s1">'sofa'</span><span class="p">,</span>   <span class="s1">'train'</span><span class="p">,</span>   <span class="s1">'tvmonitor'</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="YOLOv2's-loss-function">YOLOv2's loss function<a class="anchor-link" href="#YOLOv2's-loss-function">¶</a></h1><p>Before discussing the loss function, I will read in VOC2012 data, and call the batch generator in order to use the example batch <code> [x_batch,b_batch],y_batch</code> to demonstrate the usage of the loss funciton.</p>
<h3 id="Read-images-and-annotations-into-memory">Read images and annotations into memory<a class="anchor-link" href="#Read-images-and-annotations-into-memory">¶</a></h3><p>Use the pre-processing code for parsing annotation at <a href="https://github.com/experiencor/keras-yolo2">experiencor/keras-yolo2</a>.
This <code>parse_annoation</code> function is already used in <a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1 Object Detection using YOLOv2 on Pascal VOC2012 - anchor box clustering</a> and saved in my python script. 
This script can be downloaded at <a href="https://github.com/FairyOnIce/ObjectDetectionYolo/blob/master/backend.py">my Github repository, FairyOnIce/ObjectDetectionYolo/backend</a>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">### The location where the VOC2012 data is saved.</span>
<span class="n">train_image_folder</span> <span class="o">=</span> <span class="s2">"../ObjectDetectionRCNN/VOCdevkit/VOC2012/JPEGImages/"</span>
<span class="n">train_annot_folder</span> <span class="o">=</span> <span class="s2">"../ObjectDetectionRCNN/VOCdevkit/VOC2012/Annotations/"</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">backend</span> <span class="k">import</span> <span class="n">parse_annotation</span>
<span class="n">train_image</span><span class="p">,</span> <span class="n">seen_train_labels</span> <span class="o">=</span> <span class="n">parse_annotation</span><span class="p">(</span><span class="n">train_annot_folder</span><span class="p">,</span>
                                                  <span class="n">train_image_folder</span><span class="p">,</span> 
                                                  <span class="n">labels</span><span class="o">=</span><span class="n">LABELS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"N train = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_image</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>Using TensorFlow backend.
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>N train = 17125
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Instantiate-batch-generator-object">Instantiate batch generator object<a class="anchor-link" href="#Instantiate-batch-generator-object">¶</a></h3><p><code>SimpleBatchGenerator</code> is discussed and used in 
<a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a>.
This script can be downloaded at <a href="https://github.com/FairyOnIce/ObjectDetectionYolo/blob/master/backend.py">my Github repository, FairyOnIce/ObjectDetectionYolo/backend</a>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">backend</span> <span class="k">import</span> <span class="n">SimpleBatchGenerator</span>

<span class="n">BATCH_SIZE</span>        <span class="o">=</span> <span class="mi">500</span>
<span class="n">IMAGE_H</span><span class="p">,</span> <span class="n">IMAGE_W</span>  <span class="o">=</span> <span class="mi">416</span><span class="p">,</span> <span class="mi">416</span>
<span class="n">GRID_H</span><span class="p">,</span>  <span class="n">GRID_W</span>   <span class="o">=</span> <span class="mi">13</span> <span class="p">,</span> <span class="mi">13</span>
<span class="n">TRUE_BOX_BUFFER</span>   <span class="o">=</span> <span class="mi">50</span>
<span class="n">BOX</span>               <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># CLASS             = len(LABELS)</span>

<span class="n">generator_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'IMAGE_H'</span>         <span class="p">:</span> <span class="n">IMAGE_H</span><span class="p">,</span> 
    <span class="s1">'IMAGE_W'</span>         <span class="p">:</span> <span class="n">IMAGE_W</span><span class="p">,</span>
    <span class="s1">'GRID_H'</span>          <span class="p">:</span> <span class="n">GRID_H</span><span class="p">,</span>  
    <span class="s1">'GRID_W'</span>          <span class="p">:</span> <span class="n">GRID_W</span><span class="p">,</span>
    <span class="s1">'LABELS'</span>          <span class="p">:</span> <span class="n">LABELS</span><span class="p">,</span>
    <span class="s1">'ANCHORS'</span>         <span class="p">:</span> <span class="n">ANCHORS</span><span class="p">,</span>
    <span class="s1">'BATCH_SIZE'</span>      <span class="p">:</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
    <span class="s1">'TRUE_BOX_BUFFER'</span> <span class="p">:</span> <span class="n">TRUE_BOX_BUFFER</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">image</span> <span class="o">/</span> <span class="mf">255.</span>
<span class="n">train_batch_generator</span> <span class="o">=</span> <span class="n">SimpleBatchGenerator</span><span class="p">(</span><span class="n">train_image</span><span class="p">,</span> <span class="n">generator_config</span><span class="p">,</span>
                                             <span class="n">norm</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="p">[</span><span class="n">x_batch</span><span class="p">,</span><span class="n">b_batch</span><span class="p">],</span><span class="n">y_batch</span> <span class="o">=</span> <span class="n">train_batch_generator</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Calculating-YOLOv2's-loss-function">Calculating YOLOv2's loss function<a class="anchor-link" href="#Calculating-YOLOv2's-loss-function">¶</a></h1><p>I have seen a lot of online blog posts about YOLO v1 loss function.
For example, at <a href="https://hackernoon.com/understanding-yolo-f5a74bbc7967">Understanding YOLO</a>.
However, most of these posts discusses the loss function of Yolo v1 which must be different from Yolo v2.
The two losses are different and the lack of explicit formula in the Yolo v2 loss paper rises some confusion, for example at <a href="https://groups.google.com/forum/#!topic/darknet/TJ4dN9R4iJk">What is YOLOv2 Loss Function - Google Groups</a>.</p>
<p>The YOLO v1 is difined in 
<a href="https://arxiv.org/pdf/1506.02640.pdf">You Only Look Once:Unified, Real-Time Object Detection</a> as:</p>
<h3 id="YOLO-V1-loss">YOLO V1 loss<a class="anchor-link" href="#YOLO-V1-loss">¶</a></h3><p>$$\begin{array}{rl}
&\lambda_\textbf{coord}
\sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
     L_{ij}^{\text{obj}}
            \left[
            \left(
                x_i - \hat{x}_i
            \right)^2 +
            \left(
                y_i - \hat{y}_i
            \right)^2
            \right]
\\
&+ \lambda_\textbf{coord} 
\sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
         L_{ij}^{\text{obj}}
         \left[
        \left(
            \sqrt{w_i} - \sqrt{\hat{w}_i}
        \right)^2 +
        \left(
            \sqrt{h_i} - \sqrt{\hat{h}_i}
        \right)^2
        \right]
\\
&+ \sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
        L_{ij}^{\text{obj}}
        \left(
            C_i - \hat{C}_i
        \right)^2
\\
&+ \lambda_\textrm{noobj}
\sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
    L_{ij}^{\text{noobj}}
        \left(
            C_i - \hat{C}_i
        \right)^2
\\
&+ \sum_{i = 0}^{S^2}
L_i^{\text{obj}}
    \sum_{c \in \textrm{classes}}
        \left(
            p_i(c) - \hat{p}_i(c)
        \right)^2
\end{array}$$</p>
<p>YOLOv2 paper expalins the difference in architecture from YOLOv1 as follows:</p>
<blockquote>
We remove the fully connected layers from YOLO(v1) and use anchor boxes to predict bounding boxes...
When we move to anchor boxes we also decouple the class prediction mechanism from the spatial location and instead predict class and objectness for every anchorbox. 
</blockquote><p>This means that the confidence probability $p_i(c)$ above should depend not only on $i$ and $c$ but also an anchor box index, say $j$. Therefore, the loss needs to be different from above. Unfortunately, YOLOv2 paper does not explicitly state its loss function. So rather than making a guess based on the paper, I will try to understand the loss function that <a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a> defines for his YOLOv2.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="experiencor/keras-yolo2's-YOLO-V2-loss"><a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss<a class="anchor-link" href="#experiencor/keras-yolo2's-YOLO-V2-loss">¶</a></h3><p>In <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a>, I showed that YOLO's output is encoded into <code>y_batch</code>.</p>
<p>Here I revisit YOLO's ground truth output encoding with mathematical notations.</p>
<p><code>
y_batch
</code></p>
<p>The numpy array of shape  <code>(BATCH_SIZE, GRID_H, GRID_W, BOX, 4 + 1 + N classes) </code>.</p>
<p>BOX = The number of anchor boxes.</p>
<p>In the following notation, the grid cell index can be defined by two index (<code>igrid_h</code>,<code>igrid_w</code>) or by a single index $i$; (<code>igrid_h</code>,<code>igrid_w</code>) $\leftrightarrow i$</p>
<ul>
<li><p><code>y_batch[iframe,igrid_h,igrid_w,j,:4]</code> contains <code>(center_x,center_y,center_w,center_h)</code> of <code>j</code>th anchor at <code>grid cell=(igrid_h,igrid_w)</code> = $i$, 
  if the object exists in this (grid cell, anchor) pair, else they simply contain 0.</p>
<p><code>y_batch[iframe,igrid_h,igrid_w,j,:4]</code>$= (x_{i,\texttt{j}},y_{i,\texttt{j}},w_{i,\texttt{j}},h_{i,\texttt{j}})$</p>
</li>
</ul>
<ul>
<li><p><code>y_batch[iframe,igrid_h,igrid_w,j,4]</code> 
  contains 1 if the object exists in this (grid cell, anchor) pair, else it contains 0.</p>
<p><code>y_batch[iframe,igrid_h,igrid_w,j,4]</code> = $ C_{i,\texttt{j}}$</p>
</li>
</ul>
<ul>
<li><p><code>y_batch[iframe,igrid_h,igrid_w,j,5 + iclass]</code> contains 1 if the <code>iclass</code>th class object exists in this (grid cell, anchor) pair, else it contains 0.</p>
<p><code>y_batch[iframe,igrid_h,igrid_w,j,5:]</code> $ = (p^1_{i,\texttt{j}},p^2_{i,\texttt{j}},p^3_{i,\texttt{j}},\cdots,p^{\textrm{Nclass}}_{i,\texttt{j}})$</p>
</li>
</ul>
<p>The loss function of YOLO treats each set of elements 
<code>(center_x,center_y,center_w,center_h)</code>, 
<code>C</code>, and 
<code>(p_1,p_2,...p_Nclass)</code> in <code>y_batch[iframe,igrid_h,igrid_w,:]</code> differently. So let's understand each term of the loss one by one.</p>
<p>Then the loss corresponding to (grid cell, anchor box) pair = ($i,j$) is calculated as:</p>
<p>$$\small
%%%
\begin{array}{rl}\small
\textrm{loss}_{i,j} &= \textrm{loss}_{i,j}^{xywh} +  \textrm{loss}_{i,j}^p + \textrm{loss}_{i,j}^c \\
%%%
\textrm{loss}_{i,j}^{xywh}&=
\frac{\lambda_{\textrm{coord}}}{N_{L^{obj}}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\big[
\left(x_{i,j}-\hat{x}_{i,j}\right)^2 + 
\left(y_{i,j}-\hat{y}_{i,j}\right)^2 +\\
&\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\left(\sqrt{w}_{i,j}-\sqrt{\hat{w}}_{i,j}\right)^2 +
\left(\sqrt{h}_{i,j}-\sqrt{\hat{h}}_{i,j}\right)^2 
\big]\\
%%%
\textrm{loss}_{i,j}^p&=
-\frac{\lambda_{\text{class}}}{N_{L^{obj}}}
\sum_{i=0}^{S^2} \sum_{j=0}^B L_{i,j}^{\text{obj}}
\sum_{c \in \text{class}}  p_{i,j}^c \text{log}(\hat{p}_{i,j}^c)\\
%%%
\textrm{loss}_{i,j}^c &=
\frac{\lambda_{\text{obj}}}{N^{conf}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\left(
IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} - \widehat{C}_{i,j}
\right)^2\\
&\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;+
\frac{\lambda_{\textrm{noobj}}}{N^{conf}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{noobj}}
\left(0 - \widehat{C}_{i,j}\right)\\
\end{array}
$$</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>where:</p>
<ul>
<li>$N_{L^{obj}} = \sum_{i=0}^{S^2}
\sum_{j=0}^B L_{i,j}^{\text{obj}}$</li>
<li><p>$N^{conf} =  \sum_{i=0}^{S^2}
\sum_{j=0}^B L_{i,j}^{\text{obj}} + L_{i,j}^{\text{noobj}}(1-L_{i,j}^{\text{obj}})$</p>
</li>
<li><p>$\text{preduiction}_{i,j}=(\hat{x}_{i,j},\hat{y}_{i,j},\hat{w}_{i,j},\hat{h}_{i,j})$</p>
</li>
<li>$\text{ground truth}_{i,j}=(x_{i,j},y_{i,j},w_{i,j},h_{i,j})$</li>
<li>$\lambda_{\text{coord}}$, $\lambda_{\text{class}}$ and $\lambda_{\text{noobj}}$ are scalars to weight each loss funciton </li>
</ul>
<p>Here, $L_{i,j}^{\text{noobj}}$ and $L_{i,j}^{\text{obj}}$ are 0/1 indicator function such that:
$$
\begin{array}{rl}
L_{i,j}^{\text{obj}}
 &= 
 \begin{cases}
 1 
\;\;\text{if} \;\;C_{i,j}=1\\
 0\;\;\text{else}\\
\end{cases}\\
L_{i,j}^{\text{noobj}}
& = 
\begin{cases}
 1 \;\;\text{if}\;\;\text{max}_{i',j'}
 \;\;IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i',j'}} < 0.6 \;\text{and}\; C_{i,j} = 0\\
 0\;\;\text{else}\\
\end{cases}\\
\end{array}
$$</p>
<p>As the loss function seems complex, let's go over the  <a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss function line by line.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Global-hyperparameters-necessary-for-the-loss-function">Global hyperparameters necessary for the loss function<a class="anchor-link" href="#Global-hyperparameters-necessary-for-the-loss-function">¶</a></h3>
<pre><code>               -  true_boxes
               -  GRID_W
               -  GRID_H
               -  BATCH_SIZE
               -  ANCHORS
               -  LAMBDA_COORD
               -  LAMBDA_CLASS
               -  LAMBDA_NO_OBJECT 
               -  LAMBDA_OBJECT</code></pre>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LAMBDA_NO_OBJECT</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">LAMBDA_OBJECT</span>    <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">LAMBDA_COORD</span>     <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">LAMBDA_CLASS</span>     <span class="o">=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-1:-Adjust-prediction-output">Step 1: Adjust prediction output<a class="anchor-link" href="#Step-1:-Adjust-prediction-output">¶</a></h3><p><a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss function starts off by rescaling the prediction output. 
Notice that the predicted y_batch output can take any real values as the conv_23 layer has a linear activation function. However, the prediction outputs should be rescaled in the following range:</p>
<ol>
<li>$\hat{x}_{i,j}$ ranges between [<code>igrid_w,igrid_w+1</code>).</li>
<li>$\hat{y}_{i,j}$ ranges between [<code>igrid_h,igrid_h+1</code>)</li>
<li>$\hat{w}_{i,j}$ ranges between 0, GRID_W</li>
<li>$\hat{h}_{i,j}$ ranges between 0, GRID_H</li>
<li>$\widehat{C}_{i,j}$ ranges between 0 and 1. </li>
<li>$\widehat{p^c}_{i,j}$ ranges between 0 and 1</li>
</ol>
<p>The 1, 2, 3 and 4 are because the bounding boxes are in grid cell scale. See Bounding box encoding Section in 
  <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_cell_grid</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">BOX</span><span class="p">):</span> 
    <span class="sd">'''</span>
<span class="sd">    Helper function to assure that the bounding box x and y are in the grid cell scale</span>
<span class="sd">    == output == </span>
<span class="sd">    for any i=0,1..,batch size - 1</span>
<span class="sd">    output[i,5,3,:,:] = array([[3., 5.],</span>
<span class="sd">                               [3., 5.],</span>
<span class="sd">                               [3., 5.]], dtype=float32)</span>
<span class="sd">    '''</span>
    <span class="c1">## cell_x.shape = (1, 13, 13, 1, 1)</span>
    <span class="c1">## cell_x[:,i,j,:] = [[[j]]]</span>
    <span class="n">cell_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">),</span> <span class="p">[</span><span class="n">GRID_H</span><span class="p">]),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GRID_H</span><span class="p">,</span> <span class="n">GRID_W</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="c1">## cell_y.shape = (1, 13, 13, 1, 1)</span>
    <span class="c1">## cell_y[:,i,j,:] = [[[i]]]</span>
    <span class="n">cell_y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cell_x</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="c1">## cell_gird.shape = (16, 13, 13, 5, 2)</span>
    <span class="c1">## for any n, k, i, j</span>
    <span class="c1">##    cell_grid[n, i, j, anchor, k] = j when k = 0</span>
    <span class="c1">## for any n, k, i, j</span>
    <span class="c1">##    cell_grid[n, i, j, anchor, k] = i when k = 1    </span>
    <span class="n">cell_grid</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cell_x</span><span class="p">,</span><span class="n">cell_y</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BOX</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">cell_grid</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">adjust_scale_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">cell_grid</span><span class="p">,</span> <span class="n">ANCHORS</span><span class="p">):</span>    
    <span class="sd">"""</span>
<span class="sd">        Adjust prediction</span>
<span class="sd">        </span>
<span class="sd">        == input ==</span>
<span class="sd">        </span>
<span class="sd">        y_pred : takes any real values</span>
<span class="sd">                 tensor of shape = (N batch, NGrid h, NGrid w, NAnchor, 4 + 1 + N class)</span>
<span class="sd">        </span>
<span class="sd">        ANCHORS : list containing width and height specializaiton of anchor box</span>
<span class="sd">        == output ==</span>
<span class="sd">        </span>
<span class="sd">        pred_box_xy : shape = (N batch, N grid x, N grid y, N anchor, 2), contianing [center_y, center_x] rangining [0,0]x[grid_H-1,grid_W-1]</span>
<span class="sd">          pred_box_xy[irow,igrid_h,igrid_w,ianchor,0] =  center_x</span>
<span class="sd">          pred_box_xy[irow,igrid_h,igrid_w,ianchor,1] =  center_1</span>
<span class="sd">          </span>
<span class="sd">          calculation process:</span>
<span class="sd">          tf.sigmoid(y_pred[...,:2]) : takes values between 0 and 1</span>
<span class="sd">          tf.sigmoid(y_pred[...,:2]) + cell_grid : takes values between 0 and grid_W - 1 for x coordinate </span>
<span class="sd">                                                   takes values between 0 and grid_H - 1 for y coordinate </span>
<span class="sd">                                                   </span>
<span class="sd">        pred_Box_wh : shape = (N batch, N grid h, N grid w, N anchor, 2), containing width and height, rangining [0,0]x[grid_H-1,grid_W-1]</span>
<span class="sd">        </span>
<span class="sd">        pred_box_conf : shape = (N batch, N grid h, N grid w, N anchor, 1), containing confidence to range between 0 and 1</span>
<span class="sd">        </span>
<span class="sd">        pred_box_class : shape = (N batch, N grid h, N grid w, N anchor, N class), containing </span>
<span class="sd">    """</span>
    <span class="n">BOX</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1">## cell_grid is of the shape of </span>
    
    <span class="c1">### adjust x and y  </span>
    <span class="c1"># the bounding box bx and by are rescaled to range between 0 and 1 for given gird.</span>
    <span class="c1"># Since there are BOX x BOX grids, we rescale each bx and by to range between 0 to BOX + 1</span>
    <span class="n">pred_box_xy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">cell_grid</span> <span class="c1"># bx, by</span>
    
    <span class="c1">### adjust w and h</span>
    <span class="c1"># exp to make width and height positive</span>
    <span class="c1"># rescale each grid to make some anchor "good" at representing certain shape of bounding box </span>
    <span class="n">pred_box_wh</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">BOX</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># bw, bh</span>

    <span class="c1">### adjust confidence </span>
    <span class="n">pred_box_conf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span><span class="c1"># prob bb</span>

    <span class="c1">### adjust class probabilities </span>
    <span class="n">pred_box_class</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">5</span><span class="p">:]</span> <span class="c1"># prC1, prC2, ..., prC20</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">,</span><span class="n">pred_box_conf</span><span class="p">,</span><span class="n">pred_box_class</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-adjust_scale_prediction">Experiment <code>adjust_scale_prediction</code><a class="anchor-link" href="#Experiment-adjust_scale_prediction">¶</a></h4><p>I generate the real valued y_pred before rescaling from Normal(mean=0,sd = const/(GRID_H*GRID_W)), as this will be my weight initializer for the layer 23 when const = 1. I will set const = 10 to make the distribution variance a bit larger.</p>
<p>The bounding box parameters x, y, w, h and confidence are in the expected range. 
However, the class probabilities can take negative values. This is ok because the loss function later applies  softmax to <code>y_pred[:,:,:,:,5:]</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">print_min_max</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">title</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">{}</span><span class="s2"> MIN=</span><span class="si">{:5.2f}</span><span class="s2">, MAX=</span><span class="si">{:5.2f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">title</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vec</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"prepare inputs"</span><span class="p">)</span>
<span class="n">GRID_W</span> <span class="o">=</span> <span class="mi">13</span> 
<span class="n">GRID_H</span> <span class="o">=</span> <span class="mi">13</span> 
<span class="n">BOX</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">CLASS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LABELS</span><span class="p">)</span>
<span class="n">size</span>   <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="o">*</span><span class="n">GRID_W</span><span class="o">*</span><span class="n">GRID_H</span><span class="o">*</span><span class="n">BOX</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">CLASS</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">10</span><span class="o">/</span><span class="p">(</span><span class="n">GRID_H</span><span class="o">*</span><span class="n">GRID_W</span><span class="p">))</span> 
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">BOX</span><span class="p">,</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">CLASS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"y_pred before scaling = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"define tensor graph"</span><span class="p">)</span>
<span class="n">y_pred_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="n">cell_grid</span> <span class="o">=</span> <span class="n">get_cell_grid</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">BOX</span><span class="p">)</span>
<span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">,</span>   <span class="n">pred_box_wh_tf</span><span class="p">,</span> 
 <span class="n">pred_box_conf_tf</span><span class="p">,</span> <span class="n">pred_box_class_tf</span><span class="p">)</span> <span class="o">=</span> <span class="n">adjust_scale_prediction</span><span class="p">(</span><span class="n">y_pred_tf</span><span class="p">,</span> 
                                                                <span class="n">cell_grid</span><span class="p">,</span> 
                                                                <span class="n">ANCHORS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span>   <span class="n">pred_box_wh</span><span class="p">,</span> 
     <span class="n">pred_box_conf</span><span class="p">,</span> <span class="n">pred_box_class</span><span class="p">)</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pred_box_xy_tf</span><span class="p">,</span>   <span class="n">pred_box_wh_tf</span><span class="p">,</span>
         <span class="n">pred_box_conf_tf</span><span class="p">,</span> <span class="n">pred_box_class_tf</span><span class="p">])</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_xy </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>           
<span class="k">for</span> <span class="n">igrid_w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">[:,:,</span><span class="n">igrid_w</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                      <span class="s2">"  bounding box x at iGRID_W=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_w</span><span class="p">))</span>
<span class="k">for</span> <span class="n">igrid_h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">[:,</span><span class="n">igrid_h</span><span class="p">,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                  <span class="s2">"  bounding box y at iGRID_H=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_h</span><span class="p">))</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_wh </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box width "</span><span class="p">)</span> 
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box height"</span><span class="p">)</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_conf </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_conf</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_conf</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  confidence "</span><span class="p">)</span> 

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_class </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_class</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_class</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  class probability"</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
prepare inputs
y_pred before scaling = (500, 13, 13, 4, 25)
******************************
define tensor graph
******************************
ouput
******************************

pred_box_xy (500, 13, 13, 4, 2)
  bounding box x at iGRID_W=00 MIN= 0.44, MAX= 0.55
  bounding box x at iGRID_W=01 MIN= 1.44, MAX= 1.56
  bounding box x at iGRID_W=02 MIN= 2.44, MAX= 2.56
  bounding box x at iGRID_W=03 MIN= 3.43, MAX= 3.56
  bounding box x at iGRID_W=04 MIN= 4.44, MAX= 4.56
  bounding box x at iGRID_W=05 MIN= 5.44, MAX= 5.56
  bounding box x at iGRID_W=06 MIN= 6.44, MAX= 6.56
  bounding box x at iGRID_W=07 MIN= 7.44, MAX= 7.56
  bounding box x at iGRID_W=08 MIN= 8.44, MAX= 8.56
  bounding box x at iGRID_W=09 MIN= 9.44, MAX= 9.55
  bounding box x at iGRID_W=10 MIN=10.44, MAX=10.56
  bounding box x at iGRID_W=11 MIN=11.44, MAX=11.56
  bounding box x at iGRID_W=12 MIN=12.44, MAX=12.56
  bounding box y at iGRID_H=00 MIN= 0.44, MAX= 0.57
  bounding box y at iGRID_H=01 MIN= 1.45, MAX= 1.56
  bounding box y at iGRID_H=02 MIN= 2.44, MAX= 2.56
  bounding box y at iGRID_H=03 MIN= 3.44, MAX= 3.57
  bounding box y at iGRID_H=04 MIN= 4.44, MAX= 4.56
  bounding box y at iGRID_H=05 MIN= 5.44, MAX= 5.56
  bounding box y at iGRID_H=06 MIN= 6.44, MAX= 6.56
  bounding box y at iGRID_H=07 MIN= 7.45, MAX= 7.55
  bounding box y at iGRID_H=08 MIN= 8.44, MAX= 8.56
  bounding box y at iGRID_H=09 MIN= 9.44, MAX= 9.56
  bounding box y at iGRID_H=10 MIN=10.44, MAX=10.55
  bounding box y at iGRID_H=11 MIN=11.44, MAX=11.57
  bounding box y at iGRID_H=12 MIN=12.44, MAX=12.56

pred_box_wh (500, 13, 13, 4, 2)
  bounding box width  MIN= 0.81, MAX=13.47
  bounding box height MIN= 1.37, MAX=12.87

pred_box_conf (500, 13, 13, 4)
  confidence  MIN= 0.43, MAX= 0.57

pred_box_class (500, 13, 13, 4, 20)
  class probability MIN=-0.30, MAX= 0.29
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-2:-Extract-ground-truth-output">Step 2: Extract ground truth output<a class="anchor-link" href="#Step-2:-Extract-ground-truth-output">¶</a></h3><p>Extraction of the ground truth output is simpler than the extraction of the prediction output because the ground truth is already encoded in the correct scales.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">extract_ground_truth</span><span class="p">(</span><span class="n">y_true</span><span class="p">):</span>    
    <span class="n">true_box_xy</span>    <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># bounding box x, y coordinate in grid cell scale </span>
    <span class="n">true_box_wh</span>    <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># number of cells accross, horizontally and vertically</span>
    <span class="n">true_box_conf</span>  <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>    <span class="c1"># confidence </span>
    <span class="n">true_box_class</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">5</span><span class="p">:],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_class</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-extract_ground_truth">Experiment <code>extract_ground_truth</code><a class="anchor-link" href="#Experiment-extract_ground_truth">¶</a></h4><p>The scales of the $C_{i,j}$ and ${p^c}_{i,j}$ are different from $\widehat{C}_{i,j}$ and $\widehat{p^c}_{i,j}$, as the their ground truths take 0/1 values:</p>
<table>
<tr>
<th></th>
<th>Estimate</th>
<th>Ground truth</th>
</tr>
<tr>
<th>$C_{i,j}$</th>
<td>between 0 and 1 </td>
<td>1 (=an object exists) or 0</td>
</tr>
<tr>
<td>$p^c_{i,j}$</td>
<td>between 0 and 1</td>
<td>1 (=$c$th class object exists) or 0
    </td>
</tr>
<tr>
<td></td>
<td></td>
<td>later transfered to class index  $c$</td>
</tr>
</table><p>When $C_{i,j}=1$, the scales of $x_{i,j}$, $y_{i,j}$, $w_{i,j}$, $h_{i,j}$ are the same as $\hat{x}_{i,j}$, $\hat{y}_{i,j}$, $\hat{w}_{i,j}$, $\hat{h}_{i,j}$.
When $C_{i,j}=0$, then all bounding box parameters $x_{i,j}$, $y_{i,j}$, $w_{i,j}$, $h_{i,j}$ takes zero values as no object exists for the (grid_cell, anchor) pair.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># y_batch is the output of the simpleBatchGenerator.fit()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Input y_batch = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

<span class="n">y_batch_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="p">(</span><span class="n">true_box_xy_tf</span><span class="p">,</span> <span class="n">true_box_wh_tf</span><span class="p">,</span> 
 <span class="n">true_box_conf_tf</span><span class="p">,</span> <span class="n">true_box_class_tf</span><span class="p">)</span> <span class="o">=</span> <span class="n">extract_ground_truth</span><span class="p">(</span><span class="n">y_batch_tf</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="p">(</span><span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span> 
         <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_class</span><span class="p">)</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">true_box_xy_tf</span><span class="p">,</span>   <span class="n">true_box_wh_tf</span><span class="p">,</span> 
                     <span class="n">true_box_conf_tf</span><span class="p">,</span> <span class="n">true_box_class_tf</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_xy </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>        
<span class="k">for</span> <span class="n">igrid_w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="n">vec</span>  <span class="o">=</span> <span class="n">true_box_xy</span><span class="p">[:,:,</span><span class="n">igrid_w</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">pick</span> <span class="o">=</span> <span class="n">true_box_conf</span><span class="p">[:,:,</span><span class="n">igrid_w</span><span class="p">,:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1">## only pick C_ij = 1</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">],</span><span class="s2">"  bounding box x at iGRID_W=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_w</span><span class="p">))</span>
    
<span class="k">for</span> <span class="n">igrid_h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">vec</span>  <span class="o">=</span> <span class="n">true_box_xy</span><span class="p">[:,</span><span class="n">igrid_h</span><span class="p">,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">pick</span> <span class="o">=</span> <span class="n">true_box_conf</span><span class="p">[:,</span><span class="n">igrid_h</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1">## only pick C_ij = 1</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">],</span><span class="s2">"  bounding box y at iGRID_H=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_h</span><span class="p">))</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_wh </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_wh</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">true_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box width "</span><span class="p">)</span> 
<span class="n">print_min_max</span><span class="p">(</span><span class="n">true_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box height"</span><span class="p">)</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_conf </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"  confidence, unique value = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">true_box_conf</span><span class="o">.</span><span class="n">flatten</span><span class="p">())))</span> 

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_class </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_class</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"  class index, unique value = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">true_box_class</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Input y_batch = (500, 13, 13, 4, 25)
******************************
ouput
******************************

true_box_xy (500, 13, 13, 4, 2)
  bounding box x at iGRID_W=00 MIN= 0.23, MAX= 0.92
  bounding box x at iGRID_W=01 MIN= 1.16, MAX= 1.98
  bounding box x at iGRID_W=02 MIN= 2.00, MAX= 2.95
  bounding box x at iGRID_W=03 MIN= 3.00, MAX= 3.97
  bounding box x at iGRID_W=04 MIN= 4.00, MAX= 4.98
  bounding box x at iGRID_W=05 MIN= 5.00, MAX= 5.98
  bounding box x at iGRID_W=06 MIN= 6.00, MAX= 6.98
  bounding box x at iGRID_W=07 MIN= 7.00, MAX= 7.98
  bounding box x at iGRID_W=08 MIN= 8.00, MAX= 8.98
  bounding box x at iGRID_W=09 MIN= 9.02, MAX= 9.98
  bounding box x at iGRID_W=10 MIN=10.00, MAX=10.95
  bounding box x at iGRID_W=11 MIN=11.00, MAX=11.98
  bounding box x at iGRID_W=12 MIN=12.02, MAX=12.95
  bounding box y at iGRID_H=00 MIN= 0.52, MAX= 0.98
  bounding box y at iGRID_H=01 MIN= 1.00, MAX= 1.94
  bounding box y at iGRID_H=02 MIN= 2.00, MAX= 2.95
  bounding box y at iGRID_H=03 MIN= 3.00, MAX= 3.98
  bounding box y at iGRID_H=04 MIN= 4.00, MAX= 4.98
  bounding box y at iGRID_H=05 MIN= 5.00, MAX= 5.98
  bounding box y at iGRID_H=06 MIN= 6.00, MAX= 6.98
  bounding box y at iGRID_H=07 MIN= 7.00, MAX= 7.98
  bounding box y at iGRID_H=08 MIN= 8.00, MAX= 8.98
  bounding box y at iGRID_H=09 MIN= 9.02, MAX= 9.95
  bounding box y at iGRID_H=10 MIN=10.00, MAX=10.94
  bounding box y at iGRID_H=11 MIN=11.00, MAX=11.98
  bounding box y at iGRID_H=12 MIN=12.00, MAX=12.94

true_box_wh (500, 13, 13, 4, 2)
  bounding box width  MIN= 0.00, MAX=12.97
  bounding box height MIN= 0.00, MAX=12.97

true_box_conf (500, 13, 13, 4)
  confidence, unique value = [0. 1.]

true_box_class (500, 13, 13, 4)
  class index, unique value = [ 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19]
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-3:-calculate-$\text{loss}_{i,j}^{xywh}$">Step 3: calculate $\text{loss}_{i,j}^{xywh}$<a class="anchor-link" href="#Step-3:-calculate-$\text{loss}_{i,j}^{xywh}$">¶</a></h3><p>Now we are ready to calculate the loss specific to the bounding box parameters.</p>
<p>\begin{array}{rl}
\textrm{loss}_{i,j}^{xywh}&=
\frac{1}{N_{L^{obj}}}
\lambda_{\textrm{coord}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\big[
\left(x_{i,j}-\hat{x}_{i,j}\right)^2 + 
\left(y_{i,j}-\hat{y}_{i,j}\right)^2 +\\
&\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\left(\sqrt{w}_{i,j}-\sqrt{\hat{w}}_{i,j}\right)^2 +
\left(\sqrt{h}_{i,j}-\sqrt{\hat{h}}_{i,j}\right)^2 
\big]
\end{array}</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_loss_xywh</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span>
                   <span class="n">COORD_SCALE</span><span class="p">,</span>
                   <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">pred_box_xy</span><span class="p">,</span><span class="n">true_box_wh</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">):</span>  
    <span class="sd">'''</span>
<span class="sd">    coord_mask:      np.array of shape (Nbatch, Ngrid h, N grid w, N anchor, 1)</span>
<span class="sd">                     lambda_{coord} L_{i,j}^{obj}     </span>
<span class="sd">                         </span>
<span class="sd">    '''</span>
    
    <span class="c1"># lambda_{coord} L_{i,j}^{obj} </span>
    <span class="c1"># np.array of shape (Nbatch, Ngrid h, N grid w, N anchor, 1)</span>
    <span class="n">coord_mask</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">COORD_SCALE</span> 
    <span class="n">nb_coord_box</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">coord_mask</span> <span class="o">></span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">loss_xy</span>      <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">-</span><span class="n">pred_box_xy</span><span class="p">)</span> <span class="o">*</span> <span class="n">coord_mask</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_coord_box</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">loss_wh</span>      <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">true_box_wh</span><span class="o">-</span><span class="n">pred_box_wh</span><span class="p">)</span> <span class="o">*</span> <span class="n">coord_mask</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_coord_box</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">return</span><span class="p">(</span><span class="n">loss_xy</span> <span class="o">+</span> <span class="n">loss_wh</span><span class="p">,</span> <span class="n">coord_mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_loss_xywh">Experiment <code>calc_loss_xywh</code><a class="anchor-link" href="#Experiment-calc_loss_xywh">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [12]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LAMBDA_COORD</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">loss_xywh_tf</span><span class="p">,</span> <span class="n">coord_mask_tf</span>  <span class="o">=</span> <span class="n">calc_loss_xywh</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">,</span><span class="n">LAMBDA_COORD</span><span class="p">,</span>
                                               <span class="n">true_box_xy_tf</span><span class="p">,</span> <span class="n">pred_box_xy_tf</span><span class="p">,</span><span class="n">true_box_wh_tf</span><span class="p">,</span><span class="n">pred_box_wh_tf</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">loss_xywh</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">loss_xywh_tf</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"loss_xywh = </span><span class="si">{:4.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss_xywh</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
ouput
******************************
loss_xywh = 3.351
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-4:-calculate-$\text{loss}_{i,j}^{p}$">Step 4: calculate $\text{loss}_{i,j}^{p}$<a class="anchor-link" href="#Step-4:-calculate-$\text{loss}_{i,j}^{p}$">¶</a></h3><p>$$
\textrm{loss}_{i,j}^p=-\frac{1}{N_{L^{obj}}}
\lambda_{\text{class}}\sum_{i=0}^{S^2} \sum_{j=0}^B L_{i,j}^{\text{obj}}
\sum_{c \in \text{class}}  p_{i,j}^c \text{log}(\hat{p}_{i,j}^c)
$$</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_loss_class</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span><span class="n">CLASS_SCALE</span><span class="p">,</span> <span class="n">true_box_class</span><span class="p">,</span><span class="n">pred_box_class</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    == input ==    </span>
<span class="sd">    true_box_conf  : tensor of shape (N batch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_class : tensor of shape (N batch, N grid h, N grid w, N anchor), containing class index</span>
<span class="sd">    pred_box_class : tensor of shape (N batch, N grid h, N grid w, N anchor, N class)</span>
<span class="sd">    CLASS_SCALE    : 1.0</span>
<span class="sd">    </span>
<span class="sd">    == output ==  </span>
<span class="sd">    class_mask</span>
<span class="sd">    if object exists in this (grid_cell, anchor) pair and the class object receive nonzero weight</span>
<span class="sd">        class_mask[iframe,igridy,igridx,ianchor] = 1 </span>
<span class="sd">    else: </span>
<span class="sd">        0 </span>
<span class="sd">    '''</span>   
    <span class="n">class_mask</span>   <span class="o">=</span> <span class="n">true_box_conf</span>  <span class="o">*</span> <span class="n">CLASS_SCALE</span> <span class="c1">## L_{i,j}^obj * lambda_class</span>
    
    <span class="n">nb_class_box</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">class_mask</span> <span class="o">></span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">loss_class</span>   <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">(</span><span class="n">labels</span> <span class="o">=</span> <span class="n">true_box_class</span><span class="p">,</span> 
                                                                  <span class="n">logits</span> <span class="o">=</span> <span class="n">pred_box_class</span><span class="p">)</span>
    <span class="n">loss_class</span>   <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">loss_class</span> <span class="o">*</span> <span class="n">class_mask</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_class_box</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>   
    <span class="k">return</span><span class="p">(</span><span class="n">loss_class</span><span class="p">)</span>


<span class="c1">#Example useage of tf.gather</span>
<span class="c1">#indices = np.array([[0,0],</span>
<span class="c1">#                    [1,0],</span>
<span class="c1">#                    [0,1]])</span>

<span class="c1">#arr  = tf.constant(indices)</span>
<span class="c1">#temp = tf.gather(np.array([100,-20]), arr)</span>
<span class="c1">#with tf.Session() as sess:</span>
<span class="c1">#    t = sess.run(temp)</span>
<span class="c1">#print(t)</span>

<span class="c1">#[[100 100]</span>
<span class="c1"># [-20 100]</span>
<span class="c1"># [100 -20]]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_loss_class">Experiment <code>calc_loss_class</code><a class="anchor-link" href="#Experiment-calc_loss_class">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [14]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LAMBDA_CLASS</span>   <span class="o">=</span> <span class="mi">1</span>
<span class="n">loss_class_tf</span>  <span class="o">=</span> <span class="n">calc_loss_class</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">,</span><span class="n">LAMBDA_CLASS</span><span class="p">,</span>
                                 <span class="n">true_box_class_tf</span><span class="p">,</span><span class="n">pred_box_class_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">loss_class</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss_class_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"loss_class = </span><span class="si">{:4.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss_class</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
ouput
******************************
loss_class = 2.997
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="$\textrm{loss}_{i,j}^c$">$\textrm{loss}_{i,j}^c$<a class="anchor-link" href="#$\textrm{loss}_{i,j}^c$">¶</a></h2><p>The rest of calculation is dedicated to evaluate confidence loss $\textrm{loss}_{i,j}^c$</p>
<p>$$
\textrm{loss}_{i,j}^c =\lambda_{\text{obj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\left(
IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} - \widehat{C}_{i,j}
\right)^2+
\lambda_{\textrm{noobj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{noobj}}
\left(0 - \widehat{C}_{i,j}\right)
$$</p>
<h3 id="Step-5,-calculate-$IOU_{\text{preduiction}_{i,j}}^{\text{ground-truth}_{i,j}}-$">Step 5, calculate $IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} $<a class="anchor-link" href="#Step-5,-calculate-$IOU_{\text{preduiction}_{i,j}}^{\text{ground-truth}_{i,j}}-$">¶</a></h3><p>For each (grid cell, anchor) pair, compute IOU between ground truth bounding box and predicted bounding box.
$IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} $ is 0 if $C_{i,j}=0$.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [15]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_intersect_area</span><span class="p">(</span><span class="n">true_xy</span><span class="p">,</span><span class="n">true_wh</span><span class="p">,</span>
                       <span class="n">pred_xy</span><span class="p">,</span><span class="n">pred_wh</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    == INPUT ==</span>
<span class="sd">    true_xy,pred_xy, true_wh and pred_wh must have the same shape length</span>

<span class="sd">    p1 : pred_mins = (px1,py1)</span>
<span class="sd">    p2 : pred_maxs = (px2,py2)</span>
<span class="sd">    t1 : true_mins = (tx1,ty1) </span>
<span class="sd">    t2 : true_maxs = (tx2,ty2) </span>
<span class="sd">                 p1______________________ </span>
<span class="sd">                 |      t1___________   |</span>
<span class="sd">                 |       |           |  |</span>
<span class="sd">                 |_______|___________|__|p2 </span>
<span class="sd">                         |           |rmax</span>
<span class="sd">                         |___________|</span>
<span class="sd">                                      t2</span>
<span class="sd">    intersect_mins : rmin = t1  = (tx1,ty1)</span>
<span class="sd">    intersect_maxs : rmax = (rmaxx,rmaxy)</span>
<span class="sd">    intersect_wh   : (rmaxx - tx1, rmaxy - ty1)</span>
<span class="sd">        </span>
<span class="sd">    '''</span>
    <span class="n">true_wh_half</span> <span class="o">=</span> <span class="n">true_wh</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">true_mins</span>    <span class="o">=</span> <span class="n">true_xy</span> <span class="o">-</span> <span class="n">true_wh_half</span>
    <span class="n">true_maxes</span>   <span class="o">=</span> <span class="n">true_xy</span> <span class="o">+</span> <span class="n">true_wh_half</span>
    
    <span class="n">pred_wh_half</span> <span class="o">=</span> <span class="n">pred_wh</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">pred_mins</span>    <span class="o">=</span> <span class="n">pred_xy</span> <span class="o">-</span> <span class="n">pred_wh_half</span>
    <span class="n">pred_maxes</span>   <span class="o">=</span> <span class="n">pred_xy</span> <span class="o">+</span> <span class="n">pred_wh_half</span>    
    
    <span class="n">intersect_mins</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">pred_mins</span><span class="p">,</span>  <span class="n">true_mins</span><span class="p">)</span>
    <span class="n">intersect_maxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">pred_maxes</span><span class="p">,</span> <span class="n">true_maxes</span><span class="p">)</span>
    <span class="n">intersect_wh</span>    <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">intersect_maxes</span> <span class="o">-</span> <span class="n">intersect_mins</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">intersect_areas</span> <span class="o">=</span> <span class="n">intersect_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">intersect_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="n">true_areas</span> <span class="o">=</span> <span class="n">true_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">true_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">pred_areas</span> <span class="o">=</span> <span class="n">pred_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pred_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">union_areas</span> <span class="o">=</span> <span class="n">pred_areas</span> <span class="o">+</span> <span class="n">true_areas</span> <span class="o">-</span> <span class="n">intersect_areas</span>
    <span class="n">iou_scores</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">truediv</span><span class="p">(</span><span class="n">intersect_areas</span><span class="p">,</span> <span class="n">union_areas</span><span class="p">)</span>    
    <span class="k">return</span><span class="p">(</span><span class="n">iou_scores</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calc_IOU_pred_true_assigned</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span>
                                <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span>
                                <span class="n">pred_box_xy</span><span class="p">,</span>  <span class="n">pred_box_wh</span><span class="p">):</span>
    <span class="sd">''' </span>
<span class="sd">    == input ==</span>
<span class="sd">    </span>
<span class="sd">    true_box_conf : tensor of shape (N batch, N grid h, N grid w, N anchor )</span>
<span class="sd">    true_box_xy   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">    true_box_wh   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">    pred_box_xy   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">    pred_box_wh   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">        </span>
<span class="sd">    == output ==</span>
<span class="sd">    </span>
<span class="sd">    true_box_conf : tensor of shape (N batch, N grid h, N grid w, N anchor)</span>
<span class="sd">    </span>
<span class="sd">    true_box_conf value depends on the predicted values </span>
<span class="sd">    true_box_conf = IOU_{true,pred} if objecte exist in this anchor else 0</span>
<span class="sd">    '''</span>
    <span class="n">iou_scores</span>        <span class="o">=</span>  <span class="n">get_intersect_area</span><span class="p">(</span><span class="n">true_box_xy</span><span class="p">,</span><span class="n">true_box_wh</span><span class="p">,</span>
                                            <span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">)</span>
    <span class="n">true_box_conf_IOU</span> <span class="o">=</span> <span class="n">iou_scores</span> <span class="o">*</span> <span class="n">true_box_conf</span>
    <span class="k">return</span><span class="p">(</span><span class="n">true_box_conf_IOU</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_IOU_pred_true_assigned">Experiment <code>calc_IOU_pred_true_assigned</code><a class="anchor-link" href="#Experiment-calc_IOU_pred_true_assigned">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [16]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">true_box_conf_IOU_tf</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_assigned</span><span class="p">(</span>
                            <span class="n">true_box_conf_tf</span><span class="p">,</span>
                            <span class="n">true_box_xy_tf</span><span class="p">,</span> <span class="n">true_box_wh_tf</span><span class="p">,</span>
                            <span class="n">pred_box_xy_tf</span><span class="p">,</span>  <span class="n">pred_box_wh_tf</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">true_box_conf_IOU</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">true_box_conf_IOU_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>    
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_tf = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_xy_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_xy_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_xy_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_IOU.shape = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_IOU</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">true_box_conf_IOU</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">pick</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!=</span><span class="mi">0</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Histogram</span><span class="se">\n</span><span class="s2">N (%) nonzero true_box_conf_IOU = </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:5.2f}</span><span class="s2">%)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pick</span><span class="p">),</span>
                                                             <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pick</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"nonzero true_box_conf_IOU"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
true_box_conf_tf = Tensor("strided_slice_6:0", shape=(500, 13, 13, 4), dtype=float32)
true_box_xy_tf   = Tensor("strided_slice_4:0", shape=(500, 13, 13, 4, 2), dtype=float32)
true_box_wh_tf   = Tensor("strided_slice_5:0", shape=(500, 13, 13, 4, 2), dtype=float32)
pred_box_xy_tf   = Tensor("add:0", shape=(500, 13, 13, 4, 2), dtype=float32)
pred_box_wh_tf   = Tensor("mul:0", shape=(500, 13, 13, 4, 2), dtype=float32)
******************************
ouput
******************************
true_box_conf_IOU.shape = (500, 13, 13, 4)
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt"></div>
<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
" />
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-6:-Calculate-$\text{max}_{i',j'}">Step 6: Calculate $\text{max}_{i',j'}<a class="anchor-link" href="#Step-6:-Calculate-$\text{max}_{i',j'}">¶</a></h3><p>\;\;IOU<em>{\text{preduiction}</em>{i,j}}^{\text{ground truth}_{i',j'}}$</p>
<p>For each predicted bounded box from (grid cell, anchor box), 
calculate the best IOU, regardless of the ground truth anchor box that each object gets assigned.</p>
<p>This calculation uses true_boxes tensor. 
This tensor corresponds to the input <code>b_batch</code> from SimpleBatchGenerator, which is already introduced in <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2</a>.</p>
<p>From the previous blog, I cite the <code>b_batch</code> description.</p>
<p><code>
b_batch
</code></p>
<p>The numpy array of shape <code>(BATCH_SIZE, 1, 1, 1, TRUE_BOX_BUFFER, 4)</code>.</p>
<ul>
<li><p><code>b_batch[iframe,1,1,1,ibuffer,:]</code> 
  contains <code>ibuffer</code>th object's <code>(center_x,center_y,center_w,center_h)</code> in <code>iframe</code>th frame.</p>
</li>
<li><p>If <code>ibuffer</code> > N objects in <code>iframe</code>th frame, then the values are simply 0.</p>
</li>
<li><p><code>TRUE_BOX_BUFFER</code> has to be some large number, so that the frame with the biggest number of objects can also record all objects.</p>
</li>
<li><p>The order of the objects do not matter.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [17]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_IOU_pred_true_best</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">,</span><span class="n">true_boxes</span><span class="p">):</span>   
    <span class="sd">'''</span>
<span class="sd">    == input ==</span>
<span class="sd">    pred_box_xy : tensor of shape (N batch, N grid h, N grid w, N anchor, 2)</span>
<span class="sd">    pred_box_wh : tensor of shape (N batch, N grid h, N grid w, N anchor, 2)</span>
<span class="sd">    true_boxes  : tensor of shape (N batch, N grid h, N grid w, N anchor, 2)</span>
<span class="sd">    </span>
<span class="sd">    == output == </span>
<span class="sd">    </span>
<span class="sd">    best_ious</span>
<span class="sd">    </span>
<span class="sd">    for each iframe,</span>
<span class="sd">        best_ious[iframe,igridy,igridx,ianchor] contains</span>
<span class="sd">        </span>
<span class="sd">        the IOU of the object that is most likely included (or best fitted) </span>
<span class="sd">        within the bounded box recorded in (grid_cell, anchor) pair</span>
<span class="sd">        </span>
<span class="sd">        NOTE: a same object may be contained in multiple (grid_cell, anchor) pair</span>
<span class="sd">              from best_ious, you cannot tell how may actual objects are captured as the "best" object</span>
<span class="sd">    '''</span>
    <span class="n">true_xy</span> <span class="o">=</span> <span class="n">true_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>           <span class="c1"># (N batch, 1, 1, 1, TRUE_BOX_BUFFER, 2)</span>
    <span class="n">true_wh</span> <span class="o">=</span> <span class="n">true_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>           <span class="c1"># (N batch, 1, 1, 1, TRUE_BOX_BUFFER, 2)</span>
    
    <span class="n">pred_xy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor, 1, 2)</span>
    <span class="n">pred_wh</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor, 1, 2)</span>
    
    <span class="n">iou_scores</span>  <span class="o">=</span>  <span class="n">get_intersect_area</span><span class="p">(</span><span class="n">true_xy</span><span class="p">,</span>
                                      <span class="n">true_wh</span><span class="p">,</span>
                                      <span class="n">pred_xy</span><span class="p">,</span>
                                      <span class="n">pred_wh</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor, 50)   </span>

    <span class="n">best_ious</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">iou_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">best_ious</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_IOU_pred_true_best">Experiment <code>calc_IOU_pred_true_best</code><a class="anchor-link" href="#Experiment-calc_IOU_pred_true_best">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [18]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">true_boxes_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">b_batch</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="n">best_ious_tf</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_best</span><span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">,</span>
                                       <span class="n">pred_box_wh_tf</span><span class="p">,</span>
                                       <span class="n">true_boxes_tf</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">best_ious</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">best_ious_tf</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>    
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_xy_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"best_ious.shape = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_ious</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">best_ious</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">pick</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!=</span><span class="mi">0</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Histogram</span><span class="se">\n</span><span class="s2">N (%) nonzero best_ious = </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:5.2f}</span><span class="s2">%)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pick</span><span class="p">),</span>
                                                             <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pick</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"nonzero best_ious"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
true_box_wh_tf   = Tensor("strided_slice_5:0", shape=(500, 13, 13, 4, 2), dtype=float32)
pred_box_xy_tf   = Tensor("add:0", shape=(500, 13, 13, 4, 2), dtype=float32)
pred_box_wh_tf   = Tensor("mul:0", shape=(500, 13, 13, 4, 2), dtype=float32)
******************************
ouput
******************************
best_ious.shape = (500, 13, 13, 4)
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt"></div>
<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
6RMAAAAASUVORK5CYII=
" />
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-7:-Calculate-$\lambda_{\text{noobj}}L_{i,j}^{\text{noobj}}$-and-$\lambda_{\text{obj}}L_{i,j}^{\text{obj}}$">Step 7: Calculate $\lambda_{\text{noobj}}L_{i,j}^{\text{noobj}}$ and $\lambda_{\text{obj}}L_{i,j}^{\text{obj}}$<a class="anchor-link" href="#Step-7:-Calculate-$\lambda_{\text{noobj}}L_{i,j}^{\text{noobj}}$-and-$\lambda_{\text{obj}}L_{i,j}^{\text{obj}}$">¶</a></h3><p>For each grid cell, calculate no object mask. 
$$
\begin{array}{rl}
L_{i,j}^{\text{noobj}}
& = 
\begin{cases}
 1 \;\;\text{if}\;\;\text{max}_{i',j'}
 \;\;IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i',j'}} < 0.6 \;\text{and}\; C_{i,j} = 0\\
 0\;\;\text{else}\\
\end{cases}
\end{array}
$$</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [19]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_conf_mask</span><span class="p">(</span><span class="n">best_ious</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_conf_IOU</span><span class="p">,</span><span class="n">LAMBDA_NO_OBJECT</span><span class="p">,</span> <span class="n">LAMBDA_OBJECT</span><span class="p">):</span>    
    <span class="sd">'''</span>
<span class="sd">    == input == </span>
<span class="sd">    </span>
<span class="sd">    best_ious           : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_conf       : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_conf_IOU   : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    LAMBDA_NO_OBJECT    : 1.0</span>
<span class="sd">    LAMBDA_OBJECT       : 5.0</span>
<span class="sd">    </span>
<span class="sd">    == output ==</span>
<span class="sd">    conf_mask : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    </span>
<span class="sd">    conf_mask[iframe, igridy, igridx, ianchor] = 0</span>
<span class="sd">               when there is no object assigned in (grid cell, anchor) pair and the region seems useless i.e. </span>
<span class="sd">               y_true[iframe,igridx,igridy,4] = 0 "and" the predicted region has no object that has IoU > 0.6</span>
<span class="sd">               </span>
<span class="sd">    conf_mask[iframe, igridy, igridx, ianchor] =  NO_OBJECT_SCALE</span>
<span class="sd">               when there is no object assigned in (grid cell, anchor) pair but region seems to include some object</span>
<span class="sd">               y_true[iframe,igridx,igridy,4] = 0 "and" the predicted region has some object that has IoU > 0.6</span>
<span class="sd">               </span>
<span class="sd">    conf_mask[iframe, igridy, igridx, ianchor] =  OBJECT_SCALE</span>
<span class="sd">              when there is an object in (grid cell, anchor) pair        </span>
<span class="sd">    '''</span>

    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">best_ious</span> <span class="o"><</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">true_box_conf</span><span class="p">)</span> <span class="o">*</span> <span class="n">LAMBDA_NO_OBJECT</span>
    <span class="c1"># penalize the confidence of the boxes, which are reponsible for corresponding ground truth box</span>
    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">conf_mask</span> <span class="o">+</span> <span class="n">true_box_conf_IOU</span> <span class="o">*</span> <span class="n">LAMBDA_OBJECT</span>
    <span class="k">return</span><span class="p">(</span><span class="n">conf_mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-get_conf_mask">Experiment <code>get_conf_mask</code><a class="anchor-link" href="#Experiment-get_conf_mask">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [20]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">conf_mask_tf</span> <span class="o">=</span> <span class="n">get_conf_mask</span><span class="p">(</span><span class="n">best_ious_tf</span><span class="p">,</span> 
                             <span class="n">true_box_conf_tf</span><span class="p">,</span> 
                             <span class="n">true_box_conf_IOU_tf</span><span class="p">,</span>
                             <span class="n">LAMBDA_NO_OBJECT</span><span class="p">,</span> 
                             <span class="n">LAMBDA_OBJECT</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>  
<span class="nb">print</span><span class="p">(</span><span class="s2">"best_ious         = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_ious_tf</span><span class="p">))</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf     = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_IOU = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_IOU_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"LAMBDA_NO_OBJECT  = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LAMBDA_NO_OBJECT</span><span class="p">))</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"LAMBDA_OBJECT     = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LAMBDA_OBJECT</span><span class="p">))</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conf_mask_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">output</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>      
<span class="nb">print</span><span class="p">(</span><span class="s2">"conf_mask shape = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conf_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
best_ious         = Tensor("Max:0", shape=(500, 13, 13, 4), dtype=float32)
true_box_conf     = Tensor("strided_slice_6:0", shape=(500, 13, 13, 4), dtype=float32)
true_box_conf_IOU = Tensor("mul_9:0", shape=(500, 13, 13, 4), dtype=float32)
LAMBDA_NO_OBJECT  = 1.0
LAMBDA_OBJECT     = 5.0
******************************
output
******************************
conf_mask shape = (500, 13, 13, 4)
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-8:-Calculate-loss-for-the-confidence-$\textrm{loss}_{i,j}^c$">Step 8: Calculate loss for the confidence $\textrm{loss}_{i,j}^c$<a class="anchor-link" href="#Step-8:-Calculate-loss-for-the-confidence-$\textrm{loss}_{i,j}^c$">¶</a></h3><p>$$
\textrm{loss}_{i,j}^c =
\frac{1}{N^{conf}}\left[
\lambda_{\text{obj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\left(
IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} - \widehat{C}_{i,j}
\right)^2+
\lambda_{\textrm{noobj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{noobj}}
\left(0 - \widehat{C}_{i,j}\right)
\right]
$$</p>
<ul>
<li>$N^{conf} =  \sum_{i=0}^{S^2}
\sum_{j=0}^B L_{i,j}^{\text{obj}} + L_{i,j}^{\text{noobj}}(1-L_{i,j}^{\text{obj}})$</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [21]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_loss_conf</span><span class="p">(</span><span class="n">conf_mask</span><span class="p">,</span><span class="n">true_box_conf_IOU</span><span class="p">,</span> <span class="n">pred_box_conf</span><span class="p">):</span>  
    <span class="sd">'''</span>
<span class="sd">    == input ==</span>
<span class="sd">    </span>
<span class="sd">    conf_mask         : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_conf_IOU : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    pred_box_conf     : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    '''</span>
    <span class="c1"># the number of (grid cell, anchor) pair that has an assigned object or</span>
    <span class="c1"># that has no assigned object but some objects may be in bounding box.</span>
    <span class="c1"># N conf</span>
    <span class="n">nb_conf_box</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">conf_mask</span>  <span class="o">></span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">loss_conf</span>    <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">true_box_conf_IOU</span><span class="o">-</span><span class="n">pred_box_conf</span><span class="p">)</span> <span class="o">*</span> <span class="n">conf_mask</span><span class="p">)</span>  <span class="o">/</span> <span class="p">(</span><span class="n">nb_conf_box</span>  <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">return</span><span class="p">(</span><span class="n">loss_conf</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Experiment-calc_loss_conf">Experiment <code>calc_loss_conf</code><a class="anchor-link" href="#Experiment-calc_loss_conf">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [22]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>  
<span class="nb">print</span><span class="p">(</span><span class="s2">"conf_mask_tf         = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conf_mask_tf</span><span class="p">))</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_IOU_tf = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_IOU_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_conf_tf     = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_conf_tf</span><span class="p">))</span>

<span class="n">loss_conf_tf</span> <span class="o">=</span> <span class="n">calc_loss_conf</span><span class="p">(</span><span class="n">conf_mask_tf</span><span class="p">,</span><span class="n">true_box_conf_IOU_tf</span><span class="p">,</span> <span class="n">pred_box_conf_tf</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">loss_conf</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss_conf_tf</span><span class="p">)</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">output</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>      
<span class="nb">print</span><span class="p">(</span><span class="s2">"loss_conf = </span><span class="si">{:5.4f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss_conf</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
conf_mask_tf         = Tensor("add_11:0", shape=(500, 13, 13, 4), dtype=float32)
true_box_conf_IOU_tf = Tensor("mul_9:0", shape=(500, 13, 13, 4), dtype=float32)
pred_box_conf_tf     = Tensor("Sigmoid_1:0", shape=(500, 13, 13, 4), dtype=float32)
******************************
output
******************************
loss_conf = 0.1249
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="custom_loss(y_true,y_pred)"><code>custom_loss(y_true,y_pred)</code><a class="anchor-link" href="#custom_loss(y_true,y_pred)">¶</a></h1><p>Finally combine all the calculation above into <code>custom_loss(y_true,y_pred)</code>
Notice that true_boxes are tensor defined when the Keras model is declared. 
However, this tensor will not be passed as explicit arguments of the loss function.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [23]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">custom_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    y_true : (N batch, N grid h, N grid w, N anchor, 4 + 1 + N classes)</span>
<span class="sd">    y_true[irow, i_gridh, i_gridw, i_anchor, :4] = center_x, center_y, w, h</span>
<span class="sd">    </span>
<span class="sd">        center_x : The x coordinate center of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  w (e.g., ranging between [0,13)</span>
<span class="sd">        center_y : The y coordinate center of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  h (e.g., ranging between [0,13)</span>
<span class="sd">        w        : The width of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  w (e.g., ranging between [0,13)</span>
<span class="sd">        h        : The height of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  h (e.g., ranging between [0,13)</span>
<span class="sd">                   </span>
<span class="sd">    y_true[irow, i_gridh, i_gridw, i_anchor, 4] = ground truth confidence</span>
<span class="sd">        </span>
<span class="sd">        ground truth confidence is 1 if object exists in this (anchor box, gird cell) pair</span>
<span class="sd">    </span>
<span class="sd">    y_true[irow, i_gridh, i_gridw, i_anchor, 5 + iclass] = 1 if the object is in category <iclass> else 0</span>
<span class="sd">        </span>
<span class="sd">    '''</span>
    <span class="n">total_recall</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
    
    <span class="c1"># Step 1: Adjust prediction output</span>
    <span class="n">cell_grid</span>   <span class="o">=</span> <span class="n">get_cell_grid</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">BOX</span><span class="p">)</span>
    <span class="n">pred_box_xy</span><span class="p">,</span> <span class="n">pred_box_wh</span><span class="p">,</span> <span class="n">pred_box_conf</span><span class="p">,</span> <span class="n">pred_box_class</span> <span class="o">=</span> <span class="n">adjust_scale_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">cell_grid</span><span class="p">,</span><span class="n">ANCHORS</span><span class="p">)</span>
    <span class="c1"># Step 2: Extract ground truth output</span>
    <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_class</span> <span class="o">=</span> <span class="n">extract_ground_truth</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="c1"># Step 3: Calculate loss for the bounding box parameters</span>
    <span class="n">loss_xywh</span><span class="p">,</span> <span class="n">coord_mask</span> <span class="o">=</span> <span class="n">calc_loss_xywh</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span><span class="n">LAMBDA_COORD</span><span class="p">,</span>
                                           <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">pred_box_xy</span><span class="p">,</span><span class="n">true_box_wh</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">)</span>
    <span class="c1"># Step 4: Calculate loss for the class probabilities</span>
    <span class="n">loss_class</span>  <span class="o">=</span> <span class="n">calc_loss_class</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span><span class="n">LAMBDA_CLASS</span><span class="p">,</span>
                                   <span class="n">true_box_class</span><span class="p">,</span><span class="n">pred_box_class</span><span class="p">)</span>
    <span class="c1"># Step 5: For each (grid cell, anchor) pair, </span>
    <span class="c1">#         calculate the IoU between predicted and ground truth bounding box</span>
    <span class="n">true_box_conf_IOU</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_assigned</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span>
                                                    <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span>
                                                    <span class="n">pred_box_xy</span><span class="p">,</span> <span class="n">pred_box_wh</span><span class="p">)</span>
    <span class="c1"># Step 6: For each predicted bounded box from (grid cell, anchor box), </span>
    <span class="c1">#         calculate the best IOU, regardless of the ground truth anchor box that each object gets assigned.</span>
    <span class="n">best_ious</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_best</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">,</span><span class="n">true_boxes</span><span class="p">)</span>
    <span class="c1"># Step 7: For each grid cell, calculate the L_{i,j}^{noobj}</span>
    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">get_conf_mask</span><span class="p">(</span><span class="n">best_ious</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_conf_IOU</span><span class="p">,</span><span class="n">LAMBDA_NO_OBJECT</span><span class="p">,</span> <span class="n">LAMBDA_OBJECT</span><span class="p">)</span>
    <span class="c1"># Step 8: Calculate loss for the confidence</span>
    <span class="n">loss_conf</span> <span class="o">=</span> <span class="n">calc_loss_conf</span><span class="p">(</span><span class="n">conf_mask</span><span class="p">,</span><span class="n">true_box_conf_IOU</span><span class="p">,</span> <span class="n">pred_box_conf</span><span class="p">)</span>

    
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_xywh</span> <span class="o">+</span> <span class="n">loss_conf</span> <span class="o">+</span> <span class="n">loss_class</span>
    

    
    <span class="k">return</span> <span class="n">loss</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Experiment-custom_loss">Experiment <code>custom_loss</code><a class="anchor-link" href="#Experiment-custom_loss">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [24]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">true_boxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">b_batch</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="n">loss_tf</span>    <span class="o">=</span> <span class="n">custom_loss</span><span class="p">(</span><span class="n">y_batch_tf</span><span class="p">,</span> <span class="n">y_pred_tf</span><span class="p">)</span> 
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss_tf</span><span class="p">,</span>
                    <span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">true_boxes</span><span class="p">:</span> <span class="n">b_batch</span><span class="p">})</span>
<span class="n">loss</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[24]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>6.472822</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://github.com/FairyOnIce/ObjectDetectionYolo">FairyOnIce/ObjectDetectionYolo</a>
 contains this ipython notebook and all the functions that I defined in this notebook.</p>
</div>
</div>
</div>

<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['$','$'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        " linebreaks: { automatic: true, width: '95% container' }, " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
</div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Yumi</span>
  </span>
<time datetime="2018-12-09T20:00:00-08:00" pubdate>Sun 09 December 2018</time>  <span class="categories">
    <a class="category" href="https://FairyOnIce.github.io/tag/computer-vision.html">Computer Vision</a>
    <a class="category" href="https://FairyOnIce.github.io/tag/pascal-voc2012.html">PASCAL VOC2012</a>
    <a class="category" href="https://FairyOnIce.github.io/tag/object-detection.html">Object Detection</a>
    <a class="category" href="https://FairyOnIce.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection using YOLOv2 on Pascal VOC2012 series</a>
  </span>
</p><div class="sharing">
  <a href="https://twitter.com/share" class="twitter-share-button" data-url="https://FairyOnIce.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html" data-via="" data-counturl="https://FairyOnIce.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html" >Tweet</a>
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
</div>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://yumis-blog.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
     
    </section>
</div>
<aside class="sidebar">

<section>
    <h1>Local Search</h1></hr>
    <form class="navbar-search" action="https://FairyOnIce.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="" name="q" id="tipue_search_input"><input type="submit" value="Go!"></form></li>
</section>
    
<section>

    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="https://FairyOnIce.github.io/Part_7_Object_Detection_with_Yolo_using_VOC_2012_data_inference_video.html">Part 7 Object Detection with Yolo using VOC 2012 data - inference on video</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/Part_6_Object_Detection_with_Yolo_using_VOC_2012_data_inference_image.html">Part 6 Object Detection with Yolo using VOC 2012 data - inference on image</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/Part_5_Object_Detection_with_Yolo_using_VOC_2012_data_training.html">Part 5 Object Detection using YOLOv2 on Pascal VOC2012 - training</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html">Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/Part_3_Object_Detection_with_Yolo_using_VOC_2012_data_model.html">Part 3 Object Detection using YOLOv2 on Pascal VOC2012 - model</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="https://FairyOnIce.github.io/category/blog.html">Blog</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="https://FairyOnIce.github.io/tag/bleu.html">BLEU</a>,    <a href="https://FairyOnIce.github.io/tag/spectrogram.html">Spectrogram</a>,    <a href="https://FairyOnIce.github.io/tag/computer-vision.html">Computer Vision</a>,    <a href="https://FairyOnIce.github.io/tag/nlp.html">NLP</a>,    <a href="https://FairyOnIce.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection using YOLOv2 on Pascal VOC2012 series</a>,    <a href="https://FairyOnIce.github.io/tag/api.html">API</a>,    <a href="https://FairyOnIce.github.io/tag/pascal-voc2012.html">PASCAL VOC2012</a>,    <a href="https://FairyOnIce.github.io/tag/object-detection-using-rcnn-on-pascal-voc2012-series.html">Object Detection using RCNN on Pascal VOC2012 series</a>,    <a href="https://FairyOnIce.github.io/tag/gps-watch.html">GPS watch</a>,    <a href="https://FairyOnIce.github.io/tag/deep-learning.html">deep learning</a>,    <a href="https://FairyOnIce.github.io/tag/heroku.html">Heroku</a>,    <a href="https://FairyOnIce.github.io/tag/object-detection.html">Object Detection</a>,    <a href="https://FairyOnIce.github.io/tag/game.html">Game</a>,    <a href="https://FairyOnIce.github.io/tag/tensorflow.html">TensorFlow</a>,    <a href="https://FairyOnIce.github.io/tag/celeba.html">CelebA</a>,    <a href="https://FairyOnIce.github.io/tag/statistics.html">Statistics</a>,    <a href="https://FairyOnIce.github.io/tag/model.html">Model</a>,    <a href="https://FairyOnIce.github.io/tag/natural-language-processing.html">Natural Language Processing</a>,    <a href="https://FairyOnIce.github.io/tag/fourier-transform.html">Fourier Transform</a>  </section>


    <section>
        <h1>Social</h1>
        <ul>
            <li><a href="https://www.linkedin.com/notifications/" target="_blank">LinkedIn</a></li>
            <li><a href="https://github.com/FairyOnIce" target="_blank">Github</a></li>
        </ul>
    </section>
    <section>
        <h1>Blogroll</h1>
        <ul>
            <li><a href="https://getpelican.com/" target="_blank">Pelican</a></li>
            <li><a href="https://python.org/" target="_blank">Python.org</a></li>
        </ul>
    </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Yumi -
  <span class="credit">Powered by <a href="https://getpelican.com">Pelican</a></span>
</p></footer>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-112020731-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-112020731-1');
    ga('send', 'pageview');
</script>
	<script type="text/javascript">
	  var disqus_shortname = 'yumis-blog';
          var disqus_identifier = '/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html';
          var disqus_url = 'https://FairyOnIce.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html';
          var disqus_title = 'Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
</body>
</html>